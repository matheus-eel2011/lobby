<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pega Blinder Lobby - v9 Countdown</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8b7355;
            --primary-dark: #6b5344;
            --secondary: #c9a961;
            --accent: #1a1a1a;
            --bg-dark: #0f0e0b;
            --bg-lighter: #1a1813;
            --bg-card: #1a1813;
            --text-primary: #e8e4d8;
            --text-secondary: #a89878;
            --border: #3a3428;
            --success: #8b7355;
            --warning: #c9a961;
            --danger: #8b4949;
            --ggpoker: #c9a961;
            --pokerstars: #8b7355;
            --poker888: #4c669e;
            --yapoker: #8ea878;
            --champion: #6b5344;
            --partypoker: #c77f2c;
            --wpt: #3f4a6e;
            --kkpoker: #61af1c;
            --coinpoker: #881717;
            --suprema: #55370f;
            --jackpoker: #80166e;
            --clubgg: #271c0d;
            --qqpk: #236e6e;
        }
        .sidebar-section-content{
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px 16px;
        }

        .checkbox-item{
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (max-width: 520px){
            .sidebar-section-content{ grid-template-columns: 1fr; }
        }

        body {
            font-family: 'Georgia', 'Garamond', serif;
            background: linear-gradient(135deg, #0f0e0b 0%, #1a1813 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.6;
            letter-spacing: 0.5px;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                repeating-linear-gradient(
                    90deg,
                    rgba(255,255,255,.03),
                    rgba(255,255,255,.03) 1px,
                    transparent 1px,
                    transparent 2px
                );
            pointer-events: none;
            z-index: 1;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
            position: relative;
            z-index: 2;
        }

        .sidebar {
            width: 0;
            background: var(--bg-lighter);
            border-right: 2px solid var(--secondary);
            overflow-y: auto;
            padding: 0;
            box-shadow: inset -5px 0 15px rgba(0,0,0,0.5);
            transition: width 0.3s ease;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar.open {
            width: 320px;
            padding: 20px;
        }

        .sidebar-header {
            font-size: 18px;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 15px;
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--secondary);
            margin-bottom: 12px;
            letter-spacing: 1.5px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-section-title::after {
            content: '‚ñº';
            font-size: 8px;
            transition: transform 0.3s ease;
        }

        .sidebar-section-title.collapsed::after {
            transform: rotate(-90deg);
        }

        .sidebar-section-content {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .sidebar-section-content.collapsed {
            max-height: 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            cursor: pointer;
            accent-color: var(--secondary);
        }

        .checkbox-item label {
            cursor: pointer;
            flex: 1;
            color: var(--text-primary);
            font-size: 13px;
        }

        .weekday-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .weekday-btn {
            padding: 8px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .weekday-btn.active {
            background: var(--secondary);
            color: var(--bg-dark);
            border-color: var(--secondary);
        }

        .weekday-btn:hover {
            border-color: var(--secondary);
        }

        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 10px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 2px;
            color: var(--text-primary);
            font-size: 13px;
            margin-top: 5px;
            font-family: 'Georgia', serif;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 8px rgba(201, 169, 97, 0.2);
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: var(--secondary);
            color: var(--bg-dark);
            border: 2px solid var(--secondary);
            border-radius: 2px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        .btn-primary:hover {
            background: transparent;
            color: var(--secondary);
            box-shadow: inset 0 0 15px rgba(201, 169, 97, 0.2);
        }

        .btn-reload-api {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: var(--text-primary);
            border: 2px solid var(--primary);
            border-radius: 2px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
        }

        .btn-reload-api:hover {
            background: transparent;
            box-shadow: inset 0 0 15px rgba(139, 115, 85, 0.2);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-open {
            margin-left: 320px;
        }

        .header {
            background: linear-gradient(90deg, var(--bg-lighter) 0%, var(--accent) 100%);
            border-bottom: 2px solid var(--secondary);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toggle-sidebar {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        .toggle-sidebar:hover {
            border-color: var(--secondary);
            color: var(--secondary);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 8px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 2px;
            border: 1px solid var(--border);
        }

        .api-status.online {
            color: var(--secondary);
        }

        .api-status.offline {
            color: var(--danger);
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 10px 15px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s;
            letter-spacing: 0.5px;
        }

        .view-btn.active {
            background: var(--secondary);
            color: var(--bg-dark);
            border-color: var(--secondary);
        }

        .view-btn:hover {
            border-color: var(--secondary);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: linear-gradient(135deg, rgba(15, 14, 11, 0.9) 0%, rgba(26, 24, 19, 0.9) 100%);
        }

        .hidden {
            display: none !important;
        }

        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            overflow: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead {
            background: linear-gradient(90deg, var(--bg-lighter) 0%, var(--accent) 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 700;
            color: var(--secondary);
            text-transform: uppercase;
            font-size: 11px;
            border-bottom: 2px solid var(--secondary);
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: all 0.3s;
        }

        th::after {
            content: '';
            display: inline-block;
            width: 0;
            margin-left: 5px;
        }

        th.sort-asc::after {
            content: ' ‚ñ≤';
            color: var(--secondary);
        }

        th.sort-desc::after {
            content: ' ‚ñº';
            color: var(--secondary);
        }

        th:hover {
            background: rgba(201, 169, 97, 0.1);
            text-shadow: 0 0 8px rgba(201, 169, 97, 0.3);
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: rgba(201, 169, 97, 0.05);
            box-shadow: inset 0 0 10px rgba(201, 169, 97, 0.05);
        }

        tbody tr.registered {
            background: rgba(139, 115, 85, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: 700;
            text-align: center;
            min-width: 60px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-reg {
            background: rgba(139, 115, 85, 0.3);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .badge-turbo {
            background: rgba(201, 169, 97, 0.3);
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .badge-reg-ko {
            background: rgba(168, 128, 100, 0.3);
            color: #d4a574;
            border: 1px solid #d4a574;
        }

        .badge-turbo-ko {
            background: rgba(201, 169, 97, 0.3);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .badge-mystery {
            background: rgba(139, 73, 73, 0.3);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .badge-hyper {
            background: rgba(139, 73, 73, 0.3);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .badge-priority {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: 700;
            text-align: center;
            min-width: 75px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-very-low {
            background: rgba(168, 152, 120, 0.2);
            color: var(--text-secondary);
            border: 1px solid var(--text-secondary);
        }

        .badge-low {
            background: rgba(139, 115, 85, 0.3);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .badge-medium {
            background: rgba(201, 169, 97, 0.3);
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .badge-high {
            background: rgba(168, 115, 100, 0.3);
            color: #d4a574;
            border: 1px solid #d4a574;
        }

        .badge-very-high {
            background: rgba(139, 73, 73, 0.3);
            color: var(--danger);
            border: 2px solid var(--danger);
            font-weight: 900;
        }

        .site-badge {
            padding: 6px 12px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 700;
            color: white;
            text-align: center;
            min-width: 90px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .site-ggpoker {
            background: linear-gradient(135deg, #c9a961 0%, #b8975a 100%);
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
        }

        .site-pokerstars {
            background: linear-gradient(135deg, #8b7355 0%, #7a664a 100%);
            box-shadow: 0 2px 8px rgba(139, 115, 85, 0.3);
        }

        .site-888poker {
            background: linear-gradient(135deg, #4c669e 0%, #b8975a 100%);
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.3);
        }

        .site-yapoker {
            background: linear-gradient(135deg, #8ea878 0%, #5ca141 100%);
            box-shadow: 0 2px 8px rgba(168, 152, 120, 0.3);
        }

        .site-champion {
            background: linear-gradient(135deg, #6b5344 0%, #5a4836 100%);
            box-shadow: 0 2px 8px rgba(107, 83, 68, 0.3);
        }

         .site-partypoker {
            background: linear-gradient(135deg, #b85b21 0%, #e6a666 100%);
            box-shadow: 0 2px 8px rgba(107, 83, 68, 0.3);
        }
         
        .site-wpt {
            background: linear-gradient(135deg, #7f71b3 0%, #6021f5 100%);
            box-shadow: 0 2px 8px rgba(107, 83, 68, 0.3);
        }
        
        .site-kkpoker {
            background: linear-gradient(135deg, #61af1c 0%, #64b320 100%);
            box-shadow: 0 2px 8px rgba(107, 83, 68, 0.3);
        }
        
        .site-coinpoker {
            background: linear-gradient(135deg, #881717 0%, #881717 100%);
            box-shadow: 0 2px 8px rgba(107, 83, 68, 0.3);
        }
        
        .site-suprema {
            background: linear-gradient(135deg, #55370f 0%, #55370f 100%);
            box-shadow: 0 2px 8px rgb(255, 255, 255);
        }
        
        .site-jackpoker {
            background: linear-gradient(135deg, #80166e 0%, #80166e 100%);
            box-shadow: 0 2px 8px rgba(107, 83, 68, 0.3);
        }
        
        .site-clubgg {
            background: linear-gradient(135deg, #271c0d 0%, #271c0d 100%);
            box-shadow: 0 2px 8px rgb(255, 255, 255);
        }
        
        .site-qqpk {
            background: linear-gradient(135deg, #236e6e 0%, #236e6e 100%);
            box-shadow: 0 2px 8px rgba(107, 83, 68, 0.3);
        }

        .btn-register {
            padding: 6px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 2px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-register.active {
            background: var(--secondary);
            color: var(--bg-dark);
            border-color: var(--secondary);
            font-weight: 700;
        }

        .btn-register:hover {
            border-color: var(--secondary);
        }

        .btn-cashout {
            padding: 6px 12px;
            background: var(--primary);
            border: 1px solid var(--primary);
            color: var(--text-primary);
            border-radius: 2px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-cashout:hover:not(.disabled) {
            background: transparent;
            box-shadow: inset 0 0 8px rgba(139, 115, 85, 0.3);
        }

        .btn-cashout.disabled {
            background: var(--text-secondary);
            border-color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--secondary), transparent);
        }

        .dashboard-card-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--secondary);
            text-transform: uppercase;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .dashboard-value {
            font-size: 40px;
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 8px;
            line-height: 1;
        }

        .dashboard-value.positive {
            color: var(--secondary);
        }

        .dashboard-value.negative {
            color: var(--danger);
        }

        .dashboard-subtext {
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .grind-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .grind-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-export {
            padding: 10px 15px;
            background: var(--primary);
            color: var(--text-primary);
            border: 1px solid var(--primary);
            border-radius: 2px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .btn-export:hover {
            background: transparent;
            box-shadow: inset 0 0 15px rgba(139, 115, 85, 0.2);
        }

        .btn-export.csv {
            background: var(--secondary);
            border-color: var(--secondary);
            color: var(--bg-dark);
        }

        .btn-export.csv:hover {
            background: transparent;
            color: var(--secondary);
        }

        .btn-export.pdf {
            background: var(--danger);
            border-color: var(--danger);
            color: var(--text-primary);
        }

        .btn-export.pdf:hover {
            background: transparent;
            color: var(--danger);
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 2px solid var(--primary);
            border-radius: 0;
            padding: 20px;
            color: var(--text-primary);
            z-index: 9999;
            max-width: 400px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        @keyframes slideIn {
            from {
                transform: translateX(500px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-toast.success {
            border-color: var(--secondary);
        }

        .notification-toast.warning {
            border-color: var(--warning);
        }

        .notification-toast.error {
            border-color: var(--danger);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 2px solid var(--secondary);
            border-radius: 0;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 25px rgba(0,0,0,0.8);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-field {
            margin-bottom: 20px;
        }

        .modal-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--secondary);
            margin-bottom: 8px;
            display: block;
            letter-spacing: 0.5px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 2px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 2px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .modal-btn-save {
            background: var(--secondary);
            color: var(--bg-dark);
        }

        .modal-btn-save:hover {
            background: transparent;
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .modal-btn-cancel {
            background: var(--bg-lighter);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .modal-btn-cancel:hover {
            background: rgba(201, 169, 97, 0.1);
            border-color: var(--secondary);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table thead {
            background: var(--bg-lighter);
            border-bottom: 2px solid var(--secondary);
        }

        .history-table th {
            padding: 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: var(--secondary);
            text-transform: uppercase;
        }

        .history-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 0;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .positive {
            color: var(--secondary);
            font-weight: 700;
        }

        .negative {
            color: var(--danger);
            font-weight: 700;
        }

        /* Countdown visual */

        .countdown-badge {
            display: inline-block;
            padding: 6px 10px;
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #FFD700;
            border-radius: 4px;
            color: #FFD700;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
            animation: pulse-countdown 1s infinite;
            min-width: 80px;
            text-align: center;
        }

        @keyframes pulse-countdown {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
            }
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            min-width: 70px;
            text-align: center;
        }

        .status-aberto {
            background: rgba(139, 115, 85, 0.3);
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .status-late-reg {
            background: rgba(255, 215, 0, 0.3);
            color: #FFD700;
            border: 2px solid #FFD700;
            animation: pulse-late-reg 1s infinite;
        }

        @keyframes pulse-late-reg {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-fechado {
            background: rgba(139, 73, 73, 0.3);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .countdown-container {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        @media (max-width: 1024px) {
            .sidebar.open {
                width: 280px;
            }

            .main-content.sidebar-open {
                margin-left: 280px;
            }
        }
        
        .session-card{
        border: 1px solid var(--border);
        background: rgba(201,169,97,0.03);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 10px;
        }

        .session-header{
        display:flex;
        justify-content: space-between;
        align-items:center;
        padding: 12px 14px;
        cursor: pointer;
        }

        .session-title{
        color: var(--secondary);
        font-weight: 700;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: .6px;
        }

        .session-meta{
        color: var(--text-secondary);
        font-size: 12px;
        }

        .session-details{
        display:none;
        padding: 12px 14px 14px;
        border-top: 1px solid var(--border);
        }

        .session-card.open .session-details{
        display:block;
        }

        .session-table{
        width:100%;
        border-collapse: collapse;
        font-size: 12px;
        }

        .session-table th, .session-table td{
        padding: 8px 8px;
        border-bottom: 1px solid var(--border);
        }

        .session-actions{
        display:flex;
        gap:8px;
        }



    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">üéØ Pega Blinder</div>

        <div class="sidebar-section">
            <div class="sidebar-section-title" onclick="toggleSection(this)">Dia da Semana</div>
            <div class="sidebar-section-content">
                <div class="weekday-group" id="weekdayGroup">
                    <button class="weekday-btn active" data-day="1">Seg</button>
                    <button class="weekday-btn active" data-day="2">Ter</button>
                    <button class="weekday-btn active" data-day="3">Qua</button>
                    <button class="weekday-btn active" data-day="4">Qui</button>
                    <button class="weekday-btn active" data-day="5">Sex</button>
                    <button class="weekday-btn active" data-day="6">Sab</button>
                    <button class="weekday-btn active" data-day="0">Dom</button>
                </div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title" onclick="toggleSection(this)">Data Fixa</div>
            <div class="sidebar-section-content">
                <input type="date" id="fixedDate" placeholder="Selecione uma data">
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title" onclick="toggleSection(this)">Salas</div>
            <div class="sidebar-section-content">
                <div class="checkbox-item"><input type="checkbox" id="ggpoker" class="room-filter" value="GGPoker" checked><label for="ggpoker">GGPoker</label></div>
                <div class="checkbox-item"><input type="checkbox" id="pokerstars" class="room-filter" value="PokerStars" checked><label for="pokerstars">PokerStars</label></div>
                <div class="checkbox-item"><input type="checkbox" id="888poker" class="room-filter" value="888Poker" checked><label for="888poker">888Poker</label></div>
                <div class="checkbox-item"><input type="checkbox" id="yapoker" class="room-filter" value="YaPoker" checked><label for="yapoker">YaPoker</label></div>
                <div class="checkbox-item"><input type="checkbox" id="champion" class="room-filter" value="Champion" checked><label for="champion">Champion</label></div>
                <div class="checkbox-item"><input type="checkbox" id="partypoker" class="room-filter" value="Partypoker" checked><label for="partypoker">Partypoker</label></div>
                <div class="checkbox-item"><input type="checkbox" id="wpt" class="room-filter" value="WPT" checked><label for="wpt">WPT</label></div>
                <div class="checkbox-item"><input type="checkbox" id="kkpoker" class="room-filter" value="KKPOKER" checked><label for="kkpoker">KKPOKER</label></div>
                <div class="checkbox-item"><input type="checkbox" id="coinpoker" class="room-filter" value="CoinPoker" checked><label for="coinpoker">CoinPoker</label></div>
                <div class="checkbox-item"><input type="checkbox" id="suprema" class="room-filter" value="Suprema" checked><label for="suprema">Suprema</label></div>
                <div class="checkbox-item"><input type="checkbox" id="jackpoker" class="room-filter" value="JackPoker" checked><label for="jackpoker">JackPoker</label></div>
                <div class="checkbox-item"><input type="checkbox" id="clubgg" class="room-filter" value="ClubGG" checked><label for="clubgg">ClubGG</label></div>
                <div class="checkbox-item"><input type="checkbox" id="qqpk" class="room-filter" value="QQPK" checked><label for="qqpk">QQPK</label></div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title" onclick="toggleSection(this)">Tipos</div>
            <div class="sidebar-section-content">
                <div class="checkbox-item"><input type="checkbox" id="reg" class="type-filter" value="REG" checked><label for="reg">Reg</label></div>
                <div class="checkbox-item"><input type="checkbox" id="turbo" class="type-filter" value="TURBO" checked><label for="turbo">Turbo</label></div>
                <div class="checkbox-item"><input type="checkbox" id="reg-ko" class="type-filter" value="REG KO" checked><label for="reg-ko">Reg KO</label></div>
                <div class="checkbox-item"><input type="checkbox" id="turbo-ko" class="type-filter" value="TURBO KO" checked><label for="turbo-ko">Turbo KO</label></div>
                <div class="checkbox-item"><input type="checkbox" id="mystery" class="type-filter" value="MYSTERY" checked><label for="mystery">Mystery</label></div>
                <div class="checkbox-item"><input type="checkbox" id="hyper" class="type-filter" value="HYPER" checked><label for="hyper">Hyper</label></div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title" onclick="toggleSection(this)">Prioridade</div>
            <div class="sidebar-section-content">
                <div class="checkbox-item"><input type="checkbox" id="very-low" class="priority-filter" value="very-low" checked><label for="very-low">Very Low</label></div>
                <div class="checkbox-item"><input type="checkbox" id="low" class="priority-filter" value="low" checked><label for="low">Low</label></div>
                <div class="checkbox-item"><input type="checkbox" id="medium" class="priority-filter" value="medium" checked><label for="medium">Medium</label></div>
                <div class="checkbox-item"><input type="checkbox" id="high" class="priority-filter" value="high" checked><label for="high">High</label></div>
                <div class="checkbox-item"><input type="checkbox" id="very-high" class="priority-filter" value="very-high" checked><label for="very-high">Very High</label></div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title" onclick="toggleSection(this)">Buy-in</div>
            <div class="sidebar-section-content">
                <input type="number" id="minBuyin" placeholder="Min" value="0">
                <input type="number" id="maxBuyin" placeholder="Max" value="500">
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title" onclick="toggleSection(this)">Garantido</div>
            <div class="sidebar-section-content">
                <input type="number" id="minGuaranteed" placeholder="Min" value="0">
                <input type="number" id="maxGuaranteed" placeholder="Max" value="999999">
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title" onclick="toggleSection(this)">Status</div>
            <div class="sidebar-section-content">
                <div class="checkbox-item"><input type="checkbox" id="status-aberto" class="status-filter" value="Aberto" checked><label for="status-aberto">Aberto</label></div>
                <div class="checkbox-item"><input type="checkbox" id="status-late" class="status-filter" value="Late Reg" checked><label for="status-late">Late Reg</label></div>
                <div class="checkbox-item"><input type="checkbox" id="status-fechado" class="status-filter" value="Fechado" checked><label for="status-fechado">Fechado</label></div>
            </div>
        </div>

        <div class="sidebar-section">
            <button class="btn-primary" id="applyFilters">Aplicar Filtros</button>
            <button class="btn-reload-api" id="reloadAPI">Recarregar API</button>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title" onclick="toggleSection(this)">Perfis Salvos</div>
            <div class="sidebar-section-content">
                <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                    <input type="text" id="profileName" placeholder="Nome do perfil" style="flex: 1; margin-top: 0;">
                    <button class="btn-primary" id="saveProfile" style="flex: 0; width: auto; padding: 8px 12px; margin-top: 0;">üíæ</button>
                </div>
                <div id="profilesList" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div class="main-content" id="mainContent">
        <div class="header">
            <div class="header-left">
                <button class="toggle-sidebar" id="toggleSidebar" onclick="toggleSidebar()">‚ò∞</button>
                <div class="header-title">
                    üéØ PEGA BLINDER
                    <span class="api-status online" id="apiStatus">‚úÖ Online</span>
                </div>
            </div>
            <div class="view-toggle">
                <button class="view-btn active" data-view="list">Lobby</button>
                <button class="view-btn" data-view="control">Control</button>
                <button class="view-btn" data-view="bankroll">üí∞ Bankroll</button>
                <button class="view-btn" data-view="manual">Add Tournaments</button>
            </div>
        </div>

        <div class="content-area">
            <div id="listView" class="view-content">
                <div id="registeredTournamentsSection" 
                    style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 20px; overflow: hidden;">
    
                    <div style="padding: 15px; background: rgba(201, 169, 97, 0.1); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="color: var(--secondary); margin: 0; text-transform: uppercase; font-size: 13px; letter-spacing: 0.5px;">
                            üìå REGISTERED TOURNAMENTS
                        </h3>
                        <span id="registeredCountBadge" style="background: var(--secondary); color: var(--bg-dark); padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 12px;">0</span>
                    </div>

                    <div style="max-height: 250px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: var(--bg-dark); position: sticky; top: 0;">
                                    <th style="text-align: left; padding: 10px; border-bottom: 1px solid var(--border); color: var(--secondary); font-weight: 700; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px;">Hour</th>
                                    <th style="text-align: left; padding: 10px; border-bottom: 1px solid var(--border); color: var(--secondary); font-weight: 700; text-transform: uppercase; font-size: 10px;">Tournament</th>
                                    <th style="text-align: center; padding: 10px; border-bottom: 1px solid var(--border); color: var(--secondary); font-weight: 700; text-transform: uppercase; font-size: 10px;">Buy-in</th>
                                    <th style="text-align: center; padding: 10px; border-bottom: 1px solid var(--border); color: var(--secondary); font-weight: 700; text-transform: uppercase; font-size: 10px;">Rebuy</th>
                                    <th style="text-align: center; padding: 10px; border-bottom: 1px solid var(--border); color: var(--secondary); font-weight: 700; text-transform: uppercase; font-size: 10px;">Total</th>
                                    <th style="text-align: center; padding: 10px; border-bottom: 1px solid var(--border); color: var(--secondary); font-weight: 700; text-transform: uppercase; font-size: 10px;">Cashout</th>
                                    <th style="text-align: center; padding: 10px; border-bottom: 1px solid var(--border); color: var(--secondary); font-weight: 700; text-transform: uppercase; font-size: 10px;">L/P</th>
                                    <th style="text-align: center; padding: 10px; border-bottom: 1px solid var(--border); color: var(--secondary); font-weight: 700; text-transform: uppercase; font-size: 10px;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="registeredTournamentsBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                        Nenhum torneio registrado ainda. Clique em "Registrar" na tabela abaixo.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
     
                <div class="table-container">
                    <!-- Pagination controls (NOVO) -->
                    <div id="tournamentsPagination" style="display:flex; gap:10px; align-items:center; justify-content:space-between; margin:12px 0;">
                    <div style="color: var(--text-secondary); font-size: 12px;">
                        <span id="pageInfo">Carregando...</span>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button id="btnReloadToday" class="btn-primary" style="padding:6px 10px; font-size:12px;" onclick="resetTournamentsPagination()">
                        Hoje
                        </button>
                        <button id="btnLoadMore" class="btn-primary" style="padding:6px 10px; font-size:12px;" onclick="nextTournamentsPage()">
                        Carregar mais
                        </button>
                    </div>
                    </div>

                    <table id="tournamentTable">
                        <thead>
                        <tr>
                            <th data-column="time">‚è±Ô∏è Hora</th>
                            <th data-column="date">üìÖ Data</th>
                            <th data-column="site">Sala</th>
                            <th data-column="name">Torneio</th>
                            <th data-column="type">Tipo</th>
                            <th data-column="buyin">Buy-in</th>
                            <th data-column="guaranteed">GTD</th>
                            <th data-column="field">Field</th>
                            <th data-column="priority">‚≠ê Prioridade</th>
                            <th data-column="status">Status</th>
                            <th>Registrado</th>
                            <th>Cashout</th>
                        </tr>
                        </thead>
                        <tbody id="tournamentBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="controlView" class="view-content hidden">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">Torneios Hoje</div>
                        <div class="dashboard-value" id="dashTournamentsTotal">0</div>
                        <div class="dashboard-subtext">dispon√≠veis</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">Registrados</div>
                        <div class="dashboard-value" id="dashRegistered">0</div>
                        <div class="dashboard-subtext">nesta sess√£o</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">Total Buy-in</div>
                        <div class="dashboard-value"><span id="dashTotalBuyin">0</span></div>
                        <div class="dashboard-subtext">investimento</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">Cash Out Total</div>
                        <div class="dashboard-value"><span id="dashTotalCashout">0</span></div>
                        <div class="dashboard-subtext">retorno total</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">Lucro/Preju√≠zo</div>
                        <div class="dashboard-value" id="dashProfit">0</div>
                        <div class="dashboard-subtext" id="dashProfitROI">ROI: 0%</div>
                    </div>
                </div>

                <div class="grind-card">
                    <div class="grind-title">
                        Hist√≥rico de Registros
                        <div class="export-buttons" id="exportButtons" style="display: none;">
                            <button class="btn-export csv" onclick="exportCSVSession()">CSV Sess√£o</button>
                            <button class="btn-export pdf" onclick="exportPDFSession()">PDF Sess√£o</button>
                            <button class="btn-export csv" onclick="exportCSVGlobal()">CSV Global</button>
                            <button class="btn-export pdf" onclick="exportPDFGlobal()">PDF Global</button>

                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px; justify-content:flex-end;">
                            <button class="btn-primary" id="btnEndSession" style="padding:8px 12px; font-size:12px;">
                                Encerrar Sess√£o
                            </button>
                        </div>
                    </div>
                    <div id="historyContainer" style="color: var(--text-secondary); font-size: 12px; text-align: center; padding: 20px;">Nenhum torneio registrado ainda</div>
                </div>
            </div>
            <div id="bankrollView" class="view-content hidden">
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <!-- Gr√°fico -->
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 20px;">
                            <h3 style="color: var(--secondary); margin-bottom: 15px;">üìà Lucro Acumulado</h3>
                            <canvas id="bankrollChart" style="max-height: 300px;"></canvas>
                        </div>

                        <!-- Tabela de M√©tricas -->
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 20px;">
                            <h3 style="color: var(--secondary); margin-bottom: 15px;">üìä M√©tricas</h3>
                            <table style="width: 100%; font-size: 13px;">
                                <tbody>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 10px 0; color: var(--text-secondary);">Total Torneios:</td>
                                        <td style="padding: 10px 0; text-align: right; color: var(--text-primary); font-weight: 600;" id="bankrollTotalTournaments">0</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 10px 0; color: var(--text-secondary);">Avg Buy-in:</td>
                                        <td style="padding: 10px 0; text-align: right; color: var(--text-primary); font-weight: 600;" id="bankrollAvgBuyin">$0.00</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 10px 0; color: var(--text-secondary);">Lucro Total:</td>
                                        <td style="padding: 10px 0; text-align: right; font-weight: 600;" id="bankrollTotalProfit" style="color: var(--success);">$0.00</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 10px 0; color: var(--text-secondary);">ROI:</td>
                                        <td style="padding: 10px 0; text-align: right; color: var(--text-primary); font-weight: 600;" id="bankrollROI">0%</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 10px 0; color: var(--text-secondary);">ITM:</td>
                                        <td style="padding: 10px 0; text-align: right; color: var(--text-primary); font-weight: 600;" id="bankrollITM">0%</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px 0; color: var(--text-secondary);">Prize Total:</td>
                                        <td style="padding: 10px 0; text-align: right; color: var(--text-primary); font-weight: 600;" id="bankrollPrizeTotal">$0.00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Se√ß√£o de Configura√ß√£o de Banca -->
                    <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 20px; margin-top: 20px;">
                        <h3 style="color: var(--secondary); margin-bottom: 15px;">‚öôÔ∏è Configura√ß√£o de Banca</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div>
                                <label style="color: var(--text-secondary); font-size: 12px; display: block; margin-bottom: 5px;">Banca Inicial ($)</label>
                                <input id="bankrollInitialBank" type="number" value="1000" min="0" step="100" 
                                    style="width: 100%; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-primary); border-radius: 2px;" 
                                    onchange="updateBankrollMetrics()">
                            </div>
                            <div>
                                <label style="color: var(--text-secondary); font-size: 12px; display: block; margin-bottom: 5px;">Fator Seguran√ßa</label>
                                <input id="bankrollSafetyFactor" type="number" value="400" min="100" step="50"
                                    style="width: 100%; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-primary); border-radius: 2px;" 
                                    onchange="updateBankrollMetrics()">
                            </div>
                            <div>
                                <label style="color: var(--text-secondary); font-size: 12px; display: block; margin-bottom: 5px;">ABI Ideal ($)</label>
                                <div style="padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); color: var(--secondary); border-radius: 2px; font-weight: 600;" 
                                    id="bankrollIdealABI">$2.50</div>
                            </div>
                            <div>
                                <label style="color: var(--text-secondary); font-size: 12px; display: block; margin-bottom: 5px;">Banca Atual ($)</label>
                                <div style="padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); color: var(--secondary); border-radius: 2px; font-weight: 600;" 
                                    id="bankrollCurrentBank">$1000.00</div>
                            </div>
                        </div>
                    </div>
                    <!-- Lucro m√™s a m√™s -->
                    <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 20px; margin-top: 20px;">
                        <h3 style="color: var(--secondary); margin-bottom: 15px;">üìÜ Lucro m√™s a m√™s</h3>
                        <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--border); color: var(--secondary); text-transform: uppercase; font-size: 11px;">
                                    <th style="text-align: left; padding: 8px 0;">M√™s/Ano</th>
                                    <th style="text-align: right; padding: 8px 0;">Torneios</th>
                                    <th style="text-align: right; padding: 8px 0;">Buy-in total</th>
                                    <th style="text-align: right; padding: 8px 0;">Prize total</th>
                                    <th style="text-align: right; padding: 8px 0;">Lucro</th>
                                    <th style="text-align: right; padding: 8px 0;">ROI</th>
                                </tr>
                            </thead>
                            <tbody id="bankrollMonthlyBody">
                                <tr>
                                    <td colspan="6" style="padding: 10px 0; text-align: center; color: var(--text-secondary);">
                                        Ainda n√£o h√° dados suficientes (registre torneios com cashout).
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="manualView" class="view-content hidden">
                <div style="padding:20px">
                    <div class="grind-card">
                        <div class="grind-title">Tournament Schedule</div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            <div>
                        <label style="color:var(--text-secondary); font-size:12px;">Date</label>
                        <input type="date" id="manualDate">
                    </div>

                    <div>
                        <label style="color:var(--text-secondary); font-size:12px;">Starting</label>
                        <input type="time" id="manualTime">
                    </div>

                    <div>
                        <label style="color:var(--text-secondary); font-size:12px;">Plataform</label>
                        <select id="manualSite">
                            <option value="GGPoker">GGPoker</option>
                            <option value="PokerStars">PokerStars</option>
                            <option value="888Poker">888Poker</option>
                            <option value="YaPoker">YaPoker</option>
                            <option value="Champion">Champion</option>
                            <option value="Partypoker">Partypoker</option>
                            <option value="WPT">WPT</option>
                            <option value="Suprema">Suprema</option>
                            <option value="KKPOKER">KKPOKER</option>
                            <option value="CoinPoker">CoinPoker</option>
                            <option value="JackPoker">JackPoker</option>
                            <option value="QQPK">QQPK</option>
                            <option value="ClubGG">ClubGG</option>                                                      
                        </select>
                    </div>

                    <div>
                        <label style="color:var(--text-secondary); font-size:12px;">Type</label>
                        <select id="manualType">
                            <option value="REG">REG</option>
                            <option value="TURBO">TURBO</option>
                            <option value="REG KO">REG KO</option>
                            <option value="TURBO KO">TURBO KO</option>
                            <option value="MYSTERY">MYSTERY</option>
                            <option value="HYPER">HYPER</option>
                        </select>
                    </div>

                    <div style="grid-column: 1 / -1;">
                        <label style="color:var(--text-secondary); font-size:12px;">Name</label>
                        <input type="text" id="manualName" placeholder="Ex: Daily Special 5.50">
                    </div>

                    <div>
                        <label style="color:var(--text-secondary); font-size:12px;">Buy-in</label>
                        <input type="number" id="manualBuyin" step="0.01" value="0">
                    </div>

                    <div>
                        <label style="color:var(--text-secondary); font-size:12px;">Late Reg (min)</label>
                        <input type="number" id="manualLateReg" step="1" value="0">
                    </div>

                    <div>
                        <label style="color:var(--text-secondary); font-size:12px;">GTD</label>
                        <input type="number" id="manualGuaranteed" step="1" value="0">
                    </div>

                    <div>
                        <label style="color:var(--text-secondary); font-size:12px;">Field</label>
                        <input type="number" id="manualField" step="1" value="0">
                    </div>

                    <div>
                        <label style="color:var(--text-secondary); font-size:12px;">Priority</label>
                        <select id="manualPriority">
                            <option value="very-low">Very Low</option>
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="very-high">Very High</option>
                        </select>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:12px;">
                    <button class="btn-primary" id="btnManualSave" style="margin-top:0;">Save</button>
                    <button class="btn-primary" id="btnManualRefresh" style="margin-top:0;">Refresh</button>
                </div>
            </div>

            <div class="grind-card">
                <div class="grind-title">Tournaments Saved</div>
                <div id="manualListContainer" style="color:var(--text-secondary); font-size:12px;">
                    Carregando...
                </div>
            </div>
                </div>
        </div>

    </div>


<!-- Modal -->
<div id="cashoutModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">Registrar Cashout</div>
 
        <div class="modal-field">
            <label class="modal-label">Torneio</label>
            <div id="modalTournamentName" style="padding: 12px; background: var(--bg-dark); border-radius: 2px; color: var(--secondary); font-weight: 600;"></div>
        </div>
        <div class="modal-field">
            <label class="modal-label">Buy-in (valor base)</label>
            <div id="modalBuyin" style="padding: 12px; background: var(--bg-dark); border-radius: 2px; color: var(--text-secondary);"></div>
        </div>

        <!-- NOVO: quantidade de rebuys -->
        <div class="modal-field">
            <label class="modal-label">Rebuys (quanto voc√™ comprou)</label>
            <input type="number" id="rebuyCount" class="modal-input" placeholder="0" min="0" step="1" value="0"
                   style="width: 100%; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 2px; color: var(--text-primary); font-size: 14px;">
            <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 4px;">
                Ex: se voc√™ fez 2 rebuys al√©m do buy-in inicial, digite 2
            </small>
        </div>

        <div class="modal-field">
            <label class="modal-label">Cashout</label>
            <input type="number" id="cashoutInput" class="modal-input" placeholder="0" min="0" step="0.01"
                   style="width: 100%; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 2px; color: var(--text-primary); font-size: 14px;">
        </div>

        <!-- NOVO: mostra total investido -->
        <div style="background: rgba(201, 169, 97, 0.1); border: 1px solid var(--border); padding: 12px; border-radius: 2px; margin-bottom: 15px;">
            <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 6px;">Total Investido</div>
            <div id="modalTotalInvested" style="font-size: 18px; color: var(--secondary); font-weight: 600;">$0.00</div>
            <small style="color: var(--text-secondary); font-size: 10px;">
                (buy-in base) √ó (1 + rebuys)
            </small>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-save" onclick="saveCashout()">Salvar</button>
            <button class="modal-btn modal-btn-cancel" onclick="closeCashoutModal()">Cancelar</button>
        </div>
    </div>
</div>


<div id="notificationContainer"></div>

<script> //BLOCO 1Ô∏è‚É£: POKER NAMESPACE
    (function() {
        // ============================================
        // 1. STORAGE PRIVADO SEGURO
        // ============================================
        let _pokerStorage = {
            buyins: {},
            cashouts: {},
            currentCashoutId: null,
            storage: {},
            _initialized: false,
            _initTimestamp: null
        };

        console.log('[POKER] Storage privado criado');

        // ============================================
        // 2. VALIDA√á√ÉO DE DADOS
        // ============================================
        function validatePokerData(data) {
            if (!data || typeof data !== 'object') {
                console.warn('[POKER] ‚ùå Dados inv√°lidos recebidos:', data);
                return false;
            }
            
            // Se receber aninhado (userState.state.state), desembrulhar
            let unwrapped = data;
            if (data.state && typeof data.state === 'object' && !Array.isArray(data.state)) {
                if (data.state.state && typeof data.state.state === 'object') {
                    unwrapped = data.state.state;
                } else {
                    unwrapped = data.state;
                }
            }
            
            console.log('[POKER] Dados validados e desembrulhados:', unwrapped);
            return unwrapped;
        }

        // ============================================
        // 3. INICIALIZA√á√ÉO COM GETTER/SETTER
        // ============================================
        Object.defineProperty(window, 'POKER', {
            get() {
                // Fallback se _pokerStorage desaparecer
                if (!_pokerStorage) {
                    console.warn('[POKER] ‚ö†Ô∏è  _pokerStorage perdido, recriando...');
                    _pokerStorage = {
                        buyins: {},
                        cashouts: {},
                        currentCashoutId: null,
                        storage: {},
                        _initialized: false,
                        _initTimestamp: null
                    };
                }
                return _pokerStorage;
            },
            
            set(value) {
                const validated = validatePokerData(value);
                
                if (validated) {
                    // Merge inteligente ao inv√©s de substitui√ß√£o
                    const newState = {
                        buyins: validated.buyins || _pokerStorage.buyins,
                        cashouts: validated.cashouts || _pokerStorage.cashouts,
                        currentCashoutId: validated.currentCashoutId ?? _pokerStorage.currentCashoutId,
                        storage: validated.storage || _pokerStorage.storage,
                        registeredMeta: validated.registeredMeta ?? pokerStorage.registeredMeta ?? {},
                        _initialized: true,
                        _initTimestamp: new Date().toISOString()
                    };
                    
                    _pokerStorage = newState;
                    console.log('[POKER] ‚úÖ Storage atualizado:', _pokerStorage);
                    
                    // Atualizar aliases
                    updateAliases();
                } else {
                    console.warn('[POKER] ‚ùå Tentativa de set com dados inv√°lidos');
                }
            },
            
            configurable: true,
            enumerable: true
        });

        console.log('[POKER] ‚úÖ Prote√ß√£o ativada com storage privado');

        // ============================================
        // 4. DIAGNOSTICS - HELPER FUNCTION
        // ============================================
        window.POKER_DEBUG = {
            getStatus() {
                return {
                    pokerExists: window.POKER !== undefined,
                    pokerValue: window.POKER,
                    pokerStorage: _pokerStorage,
                    buyinsCount: Object.keys(window.POKER?.buyins || {}).length,
                    cashoutCount: Object.keys(window.POKER?.cashouts || {}).length,
                    initialized: window.POKER?._initialized || false,
                    timestamp: window.POKER?._initTimestamp
                };
            },
            
            logStatus() {
                const status = this.getStatus();
                console.group('[POKER_DEBUG] Status Completo');
                console.table(status);
                console.log('window.POKER:', status.pokerValue);
                console.log('_pokerStorage:', status.pokerStorage);
                console.groupEnd();
            },
            
            reset() {
                _pokerStorage = {
                    buyins: {},
                    cashouts: {},
                    registeredMeta: {},
                    currentCashoutId: null,
                    storage: {},
                    _initialized: false,
                    _initTimestamp: null
                };
                console.log('[POKER_DEBUG] ‚úÖ Storage resetado');
            }
        };

        // ============================================
        // 5. FUN√á√ïES DE SUPORTE
        // ============================================
        function updateAliases() {
            if (window.POKER) {
                window.buyins = window.POKER.buyins;
                window.cashouts = window.POKER.cashouts;
                window.currentCashoutId = window.POKER.currentCashoutId;
                console.log('[POKER] ‚úÖ Aliases atualizados');
            }
        }

        // ============================================
        // 6. INICIALIZA√á√ÉO DE ALIASES
        // ============================================
        updateAliases();
        
        // ============================================
        // 7. FUN√á√ÉO PARA CARREGAR DADOS
        // ============================================
        window.loadPokerData = function(userState) {
            console.log('[loadPokerData] Entrada recebida:', userState);
            
            if (!userState || !userState.state) {
                console.error('[loadPokerData] ‚ùå userState inv√°lido:', userState);
                return false;
            }
            const savedSettings =
                userState?.state?.state?.bankrollSettings ||
                userState?.state?.bankrollSettings ||
                userState?.bankrollSettings;

            if (savedSettings) {
                const initial = Number(savedSettings.initialBank ?? 0);
                const safety = Number(savedSettings.safetyFactor ?? 0);

                const elInitial = document.getElementById('bankrollInitialBank');
                const elSafety = document.getElementById('bankrollSafetyFactor');

                if (elInitial) elInitial.value = initial;
                if (elSafety) elSafety.value = safety;
            }

            
            let pokerData = userState.state;
            
            // Desembrulhar se necess√°rio
            if (pokerData && pokerData.state) {
                console.log('[loadPokerData] Desembrulhando dados aninhados...');
                pokerData = pokerData.state;
            }
            
            console.log('[loadPokerData] Carregando dados:', pokerData);
            
            // AQUI √© a atribui√ß√£o que dispara o setter
            window.POKER = pokerData;
            
            // Verificar se carregou
            const status = window.POKER_DEBUG.getStatus();
            console.log('[loadPokerData] ‚úÖ Carregamento completo:', status);
            
            return status.initialized;
        };
        
        console.log('[POKER] Sistema inicializado. Use POKER_DEBUG.logStatus() para diagnostics');
        // ============================================
        // 8. EXPORTAR updateAliases PARA GLOBAL
        // ============================================
        window.updateAliases = updateAliases;
        
        console.log('[POKER] ‚úÖ updateAliases exportada globalmente');
    })();
    
</script>
<script> //BLOCO 2Ô∏è‚É£: STORAGE MODULE (API)

let isLoadingData = false;  // ‚Üê Nova flag
let dataLoaded = false;     // ‚Üê Nova flag

// CARREGAR M√âTRICAS DE BANKROLL
async function loadBankrollMetrics() {
    if (!window.CURRENTUSERID) {
        console.log('[Storage] User ID n√£o dispon√≠vel para carregar m√©tricas');
        return null;
    }

    try {
        const response = await fetch(`/api/storage/bankroll-metrics?userId=${window.CURRENTUSERID}`);
        const result = await response.json();

        if (result.success && result.data && result.data.metrics) {
            console.log('[Storage] ‚úÖ M√©tricas carregadas:', result.data.metrics);
            return result.data.metrics;
        }

        console.log('[Storage] Nenhuma m√©trica encontrada');
        return null;
    } catch (error) {
        console.error('[Storage] Erro ao carregar m√©tricas:', error);
        return null;
    }
};

    // RESTAURAR M√âTRICAS NA INTERFACE
async function restoreBankrollMetricsUI(metrics) {
    if (!metrics) return;

    try {
        document.getElementById('bankrollTotalTournaments').textContent = metrics.totalTournaments;
        document.getElementById('bankrollAvgBuyin').textContent = '$' + metrics.avgBuyin.toFixed(2);
            
        const profitEl = document.getElementById('bankrollTotalProfit');
        profitEl.textContent = '$' + metrics.totalProfit.toFixed(2);
        profitEl.style.color = metrics.totalProfit >= 0 ? 'var(--success)' : 'var(--danger)';
           
        document.getElementById('bankrollROI').textContent = metrics.roi.toFixed(2) + '%';
        document.getElementById('bankrollITM').textContent = metrics.itm.toFixed(2) + '%';
        document.getElementById('bankrollPrizeTotal').textContent = '$' + metrics.prizeTotal.toFixed(2);
        document.getElementById('bankrollIdealABI').textContent = '$' + metrics.idealABI.toFixed(2);
            
        const currentBankEl = document.getElementById('bankrollCurrentBank');
        currentBankEl.textContent = '$' + metrics.currentBank.toFixed(2);
        currentBankEl.style.color = metrics.currentBank >= metrics.initialBank ? 'var(--success)' : 'var(--danger)';

        // Restaurar inputs de configura√ß√£o
        document.getElementById('bankrollInitialBank').value = metrics.initialBank;
        document.getElementById('bankrollSafetyFactor').value = metrics.safetyFactor;

        console.log('[Storage] ‚úÖ M√©tricas restauradas na UI');
    } catch (error) {
        console.error('[Storage] Erro ao restaurar m√©tricas:', error);
    }
};  


window.manualTournaments = window.manualTournaments || [];

function getDayOfWeekFromYYYYMMDD(dateStr) {
  if (!dateStr) return new Date().getDay();
  const [y, m, d] = dateStr.split('-').map(Number);
  return new Date(y, m - 1, d).getDay(); // 0=Dom ... 6=S√°b
}

async function loadManualTournamentsFromSupabasePublic() {
  const res = await fetch('/api/storage/manual-tournaments-public');
  const text = await res.text();

  let json;
  try {
    json = JSON.parse(text);
  } catch (e) {
    throw new Error(`Resposta n√£o-JSON (HTTP ${res.status}): ${text.slice(0, 120)}`);
  }

  if (!res.ok) throw new Error(json?.error || `HTTP ${res.status}`);
  if (!json?.success) throw new Error(json?.error || 'Falha ao carregar torneios manuais');

  const raw = Array.isArray(json.data) ? json.data
            : (json.data && typeof json.data === "object") ? [json.data]
            : [];

  return raw.map(t => ({
    ...t,
    lateReg: t.lateReg ?? t.late_reg ?? 0,
    day: t.day ?? getDayOfWeekFromYYYYMMDD(t.date),
    createdAt: t.createdAt ?? t.created_at,
  }));
}



function renderManualList() {
  const el = document.getElementById('manualListContainer');
  if (!el) return;

  const arr = Array.isArray(window.manualTournaments) ? window.manualTournaments : [];
  if (arr.length === 0) {
    el.innerHTML = 'Nenhum torneio manual cadastrado ainda.';
    return;
  }

  el.innerHTML = `
    <table class="history-table">
      <thead>
        <tr>
          <th>Data</th><th>Hora</th><th>Sala</th><th>Torneio</th><th>Buy-in</th>
        </tr>
      </thead>
      <tbody>
        ${arr
          .slice()
          .sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time))
          .map(t => `
            <tr>
              <td>${t.date}</td>
              <td>${t.time}</td>
              <td>${t.site}</td>
              <td>${t.name}</td>
              <td style="text-align:right;">${Number(t.buyin).toFixed(2)}</td>
            </tr>
          `).join('')}
      </tbody>
    </table>
  `;
}

async function saveManualTournamentPublic(payload) {
  const res = await fetch('/api/storage/manual-tournaments-public', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  if (!res.ok || !json?.success) throw new Error(json?.error || `HTTP ${res.status}`);
  return json.data;
}


function getManualFormPayload() {
  return {
    date: document.getElementById('manualDate')?.value,
    time: document.getElementById('manualTime')?.value,
    site: document.getElementById('manualSite')?.value,
    type: document.getElementById('manualType')?.value,
    name: document.getElementById('manualName')?.value?.trim(),
    buyin: Number(document.getElementById('manualBuyin')?.value || 0),
    lateReg: Number(document.getElementById('manualLateReg')?.value || 0),
    guaranteed: Number(document.getElementById('manualGuaranteed')?.value || 0),
    field: Number(document.getElementById('manualField')?.value || 0),
    priority: document.getElementById('manualPriority')?.value || 'medium'
  };
}

async function refreshManualTournamentsUI() {
  window.manualTournaments = await loadManualTournamentsFromSupabasePublic();
  renderManualList();

  // Atualiza lista principal tamb√©m (desde que applyFilters use a fonte mesclada)
  if (typeof applyFilters === 'function') applyFilters();
}

document.getElementById('btnManualRefresh')?.addEventListener('click', async () => {
  try {
    await refreshManualTournamentsUI();
    if (typeof showNotification === 'function') showNotification('OK', 'Manuais recarregados.', 'success');
  } catch (e) {
    console.error(e);
    if (typeof showNotification === 'function') showNotification('Erro', e.message, 'error');
  }
});

document.getElementById('btnManualSave')?.addEventListener('click', async () => {
  try {
    const payload = getManualFormPayload();
    if (!payload.date || !payload.time || !payload.name) {
      if (typeof showNotification === 'function') showNotification('Aviso', 'Preencha Data, Hora e Nome.', 'warning');
      return;
    }

    await saveManualTournamentPublic(payload);
    await refreshManualTournamentsUI();

    if (typeof showNotification === 'function') showNotification('Salvo!', 'Torneio manual cadastrado.', 'success');
  } catch (e) {
    console.error(e);
    if (typeof showNotification === 'function') showNotification('Erro', e.message, 'error');
  }
});

function mergeTournamentsById(apiList, manualList) {
  const api = Array.isArray(apiList) ? apiList : [];
  const manual = Array.isArray(manualList) ? manualList : [];

  const map = new Map();
  for (const t of api) map.set(String(t.id), t);
  for (const t of manual) map.set(String(t.id), t); // manual sobrescreve se mesmo id

  return Array.from(map.values());
}


const storageModule = {
   async saveUserState(data) {
    // ‚ö†Ô∏è N√£o salvar durante carregamento
    if (isLoadingData || !dataLoaded) {
        console.log('[Storage] ‚è∏Ô∏è Salvamento bloqueado - aguardando carregamento de dados');
        return null;
    }

    if (!window.CURRENTUSERID) {
        console.warn('[Storage] User ID n√£o dispon√≠vel');
        return null;
    }

    // ‚úÖ Evita sobrescrever no Supabase com estado vazio acidental
    const buyinsNow = window.buyins || {};
    const cashoutsNow = window.cashouts || {};
    const initialBank = Number(document.getElementById('bankrollInitialBank')?.value ?? 0);
    const safetyFactor = Number(document.getElementById('bankrollSafetyFactor')?.value ?? 0);
    const hasSomeData =
        Object.keys(buyinsNow).length > 0 || Object.keys(cashoutsNow).length > 0;

    if (!hasSomeData) {
        console.warn('[Storage] Salvamento ignorado: buyins/cashouts vazios');
        return null;
    }

    try {
        // ‚úÖ FORMATO CERTO: { userId, state: {...} }
        const payload = {
        userId: window.CURRENTUSERID,
        state: {
            buyins: buyinsNow,
            cashouts: cashoutsNow,
            currentCashoutId: window.currentCashoutId ?? null,
            selectedGames: Array.from(window.selectedGames || ['ALL']),
            selectedVenues: Array.from(window.selectedVenues || ['ALL']),
            filteredTournaments: window.filteredTournaments || [],
            bankrollSettings: { initialBank, safetyFactor },
            ...(data || {}),
        },
        };

        console.log('[Storage] Salvando com payload:', payload);

        const response = await fetch('/api/storage/user-state', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        });

        const result = await response.json();
        console.log('[Storage] ‚úÖ saveUserState result:', result);
        return result;
    } catch (error) {
        console.error('[Storage] Erro:', error);
        return null;
    }
    },

    async updateBankroll(amount) {
        if (!window.CURRENTUSERID) return;
        try {
            const response = await fetch('/api/storage/bankroll', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                amount: Number(amount) || 0, 
                userId: window.CURRENTUSERID 
                })
            });
            const result = await response.json();
                console.log('[Storage] Bankroll atualizado:', result);
                return result;
        } catch (error) {
                console.error('[Storage] Erro:', error);
        }
    },
    async saveCashout(cashoutValue, baseBuyin, rebuyCount, totalInvested) {
            if (!window.CURRENTUSERID) {
                console.warn('[Storage] User ID n√£o dispon√≠vel');
                return;
            }

            try {
                // 1Ô∏è‚É£ CRIAR DADOS DO CASHOUT
                const cashoutData = {
                    amount: Number(cashoutValue) || 0,
                    baseBuyin: Number(baseBuyin) || 0,
                    rebuyCount: Number(rebuyCount) || 0,
                    totalInvested: Number(totalInvested) || 0,
                    timestamp: new Date().toISOString(),
                    userId: window.CURRENTUSERID
                };

                console.log('[Storage] Enviando cashout:', cashoutData);

                // 2Ô∏è‚É£ SALVAR CASHOUT INDIVIDUAL
                const response = await fetch('/api/storage/cashout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cashoutData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('[Storage] ‚úÖ Cashout salvo no endpoint:', result);
                
                // 3Ô∏è‚É£ SINCRONIZAR ESTADO COMPLETO COM SUPABASE
                
                console.log('[Storage] Sincronizando estado completo (buyins + cashouts)...');
             
                if (typeof window.saveCurrentUserState === 'function') {
                    const syncResult = await window.saveCurrentUserState({
                        buyins: window.POKER?.buyins || window.buyins,
                        cashouts: window.POKER?.cashouts || window.cashouts
                    });
                    console.log('[Storage] ‚úÖ Estado sincronizado com Supabase:', syncResult);
                }
            } catch (error) {
                console.error('[Storage] Erro:', error);
            }
        },
    async saveUsersToStorage(usersList) {
        if (!window.CURRENTUSERID) return;

        try {
            const response = await fetch('/api/storage/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                users: usersList || [], 
                userId: window.CURRENTUSERID 
                })
            });
            const result = await response.json();
            console.log('[Storage] Users salvo:', result);
            return result;
        } catch (error) {
            console.error('[Storage] Erro:', error);
        }
    },
}
window.storageModule = storageModule
/// 1. CARREGAR DADOS DO SUPABASE
window.loadUserData = async function () {
  if (!window.CURRENTUSERID) {
    console.warn('[Storage] User ID n√£o dispon√≠vel para carregar dados');
    return;
  }

  try {
    isLoadingData = true;
    console.log('[Storage] Carregando dados do usu√°rio...');

    const response = await fetch(`/api/storage/get-data?userId=${window.CURRENTUSERID}`);
    const result = await response.json();

    console.log('[Storage] Resposta bruta:', result);

    if (!(result.success && result.data && result.data.userState)) {
      console.warn('[Storage] Nenhum dado encontrado para restaurar');

      // Inicializar estruturas vazias
      window.registeredTournaments = new Map();
      window.filteredTournaments = [];
      window.buyins = {};
      window.cashouts = {};

      dataLoaded = true;
      return;
    }

    const userState = result.data.userState;

    console.log('[Storage] userState completo:', userState);
    console.log('[Storage] userState.state:', userState.state);
    console.log('[Storage] userState.state.state:', userState.state?.state);

    // USAR A FUN√á√ÉO CENTRALIZADA
    const loadedSuccessfully = window.loadPokerData(userState);

    if (!loadedSuccessfully) {
      console.warn('[Storage] Falha ao carregar dados via loadPokerData');

      // ‚ö†Ô∏è no seu arquivo parece existir POKERDEBUG (sem underscore)
      if (window.POKERDEBUG?.reset) window.POKERDEBUG.reset();

      window.registeredTournaments = new Map();
      window.filteredTournaments = [];
      window.buyins = {};
      window.cashouts = {};

      dataLoaded = true;
      return;
    }

    console.log('[Storage] ‚úÖ Dados carregados em window.POKER');
    console.log('[Storage] ‚úÖ Buyins restaurados:', window.POKER.buyins);
    console.log('[Storage] ‚úÖ Cashouts restaurados:', window.POKER.cashouts);

    // ===== 1) ALIASES PRIMEIRO (antes de qualquer restore que dependa deles) =====
    console.log('[Storage] Criando aliases globais...');
    window.buyins = window.POKER?.buyins || {};
    window.cashouts = window.POKER?.cashouts || {};
    window.currentCashoutId = window.POKER?.currentCashoutId ?? null;
    console.log('[Storage] ‚úÖ Aliases criados');
    console.log('[Storage] ‚úÖ window.buyins:', window.buyins);
    console.log('[Storage] ‚úÖ window.cashouts:', window.cashouts);
    
    window.registeredMeta = window.POKER?.registeredMeta || {};

    // ===== 2) RESTAURAR filteredTournaments do estado salvo =====
    if (userState.state?.state?.filteredTournaments && Array.isArray(userState.state.state.filteredTournaments)) {
      window.filteredTournaments = userState.state.state.filteredTournaments;
      console.log('[Storage] ‚úÖ filteredTournaments restaurado:', window.filteredTournaments.length, 'torneios');
    } else {
      window.filteredTournaments = [];
      console.log('[Storage] filteredTournaments vazio, inicializando');
    }

    // ===== 3) RESTAURAR selectedGames / selectedVenues =====
    console.log('[Storage] Restaurando vari√°veis globais...');

    if (userState.state?.state?.selectedGames && Array.isArray(userState.state.state.selectedGames)) {
      window.selectedGames = new Set(userState.state.state.selectedGames);
      console.log('[Storage] ‚úÖ selectedGames restaurado:', window.selectedGames);
    } else {
      window.selectedGames = new Set(['ALL']);
      console.log('[Storage] selectedGames vazio, iniciando com ALL');
    }

    if (userState.state?.state?.selectedVenues && Array.isArray(userState.state.state.selectedVenues)) {
      window.selectedVenues = new Set(userState.state.state.selectedVenues);
      console.log('[Storage] ‚úÖ selectedVenues restaurado:', window.selectedVenues);
    } else {
      window.selectedVenues = new Set(['ALL']);
      console.log('[Storage] selectedVenues vazio, iniciando com ALL');
    }

    // ===== 4) RESTAURAR registeredTournaments (PENDENTES) =====
    console.log('[Init] üîÑ Reconstruindo registeredTournaments via buyins (pendentes)...');

    if (!(window.registeredTournaments instanceof Map)) window.registeredTournaments = new Map();
    window.registeredTournaments.clear();

    // snapshot salvo (se existir)
    window.registeredMeta = window.registeredMeta || window.POKER?.registeredMeta || {};

    // ===== RESTAURAR SESS√ïES (Supabase) =====
    const st = userState?.state?.state || {};

    window.sessionsMeta =
    (st.sessionsMeta && !Array.isArray(st.sessionsMeta) && typeof st.sessionsMeta === "object")
        ? st.sessionsMeta
        : {};

    window.sessions = Array.isArray(st.sessions) ? st.sessions : [];

    if (
    st.currentSession &&
    typeof st.currentSession === "object" &&
    Array.isArray(st.currentSession.tournamentIds)
    ) {
    window.currentSession = st.currentSession;
    }

    if (typeof window.ensureCurrentSession === "function") window.ensureCurrentSession();

    Object.keys(window.buyins || {}).forEach((idStr) => {
    const id = Number(idStr);

    // pendente = cashout null/undefined
    const cashVal = window.cashouts?.[id];
    if (cashVal !== null && cashVal !== undefined) return;

    // 1) Preferir snapshot persistido
    const snap = window.registeredMeta?.[id];
    if (snap) {
        window.registeredTournaments.set(id, snap);
        return;
    }
    
    

    // 2) Tentar match na lista atual (se existir)
    const tournament =
        (window.filteredTournaments || []).find(t => Number(t.id) === id) ||
        (window.allTournamentsData || []).find(t => Number(t.id) === id) ||
        null;

    if (tournament) {
        window.registeredTournaments.set(id, tournament);
        return;
    }

    // 3) Fallback: stub (n√£o some)
    const base = window.buyins?.[id] || {};
    window.registeredTournaments.set(id, {
        id,
        name: `Torneio #${id}`,
        site: '-',
        type: '-',
        buyin: base.baseBuyin ?? base.totalInvested ?? 0,
        date: '',
        time: ''
    });

    console.warn('[Init] ‚ö†Ô∏è Torneio pendente sem match na lista, stub:', id);
    });

    console.log('[Init] ‚úÖ Pendentes reconstru√≠dos:', window.registeredTournaments.size);

    // badge
    const badge = document.getElementById('registeredCountBadge');
    if (badge) badge.textContent = window.registeredTournaments.size;

    // ===== 5) Render / dashboard =====
    if (typeof renderTable === 'function') {
      console.log('[Storage] Renderizando tabela...');
      setTimeout(() => {
        renderTable();
        if (typeof updateControlDashboard === 'function') updateControlDashboard();
      }, 100);
    }

    function ensureCurrentSession(){
    if (!window.currentSession || !Array.isArray(window.currentSession.tournamentIds)){
        const now = new Date().toISOString();
        window.currentSession = {
        id: crypto?.randomUUID ? crypto.randomUUID() : `sess-${Date.now()}`,
        startedAt: now,
        tournamentIds: []
        };
    }
    }

    // ===== 6) M√©tricas bankroll =====
    console.log('[Storage] Carregando m√©tricas de bankroll...');
    const savedMetrics = await loadBankrollMetrics();
    if (savedMetrics && savedMetrics.totalTournaments > 0) {
      console.log('[Storage] Restaurando m√©tricas na UI...');
      restoreBankrollMetricsUI(savedMetrics);
    } else {
      console.log('[Storage] Nenhuma m√©trica salva encontrada');
    }

    console.log('[Storage] ‚úÖ Estado final:');
    console.log('[Storage]   - registeredTournaments:', window.registeredTournaments.size, 'torneios');
    console.log('[Storage]   - filteredTournaments:', window.filteredTournaments.length, 'torneios');
    console.log('[Storage]   - buyins:', Object.keys(window.buyins).length, 'registros');
    console.log('[Storage]   - cashouts:', Object.keys(window.cashouts).length, 'registros');

    dataLoaded = true;
    return result.data;

  } catch (error) {
    console.error('[Storage] Erro ao carregar dados:', error);

    window.registeredTournaments = new Map();
    window.filteredTournaments = [];
    window.buyins = {};
    window.cashouts = {};
    dataLoaded = true;

  } finally {
    isLoadingData = false;
  }
};





// ============================================
// 2. SALVAR CASHOUT COM SINCRONIZA√á√ÉO
// ============================================
window.saveCashout = async function() {
  // ‚úÖ NOVO: Bloquear se estiver carregando dados
  if (isLoadingData) {
    console.log('[Storage] ‚ö†Ô∏è Salvamento bloqueado - ainda carregando dados');
    return;
  }

  if (!dataLoaded) {
    console.log('[Storage] ‚ö†Ô∏è Salvamento bloqueado - dados ainda n√£o foram carregados');
    return;
  }

  if (window.POKER.currentCashoutId === null) {
    return;
  }

  try {
    // Capturar valores do formul√°rio
    const baseBuyin = parseFloat(
      document.getElementById('modalBuyin').textContent.replace(',', '') || 0
    );
    const rebuyCount = parseInt(document.getElementById('rebuyCount').value || 0);
    const cashoutValue = parseFloat(document.getElementById('cashoutInput').value || 0);
    const totalInvested = baseBuyin * (1 + rebuyCount);

    console.log('[Storage] Valores capturados:', { baseBuyin, rebuyCount, cashoutValue, totalInvested });

    // COPIAR ESTADO ATUAL
    const updatedBuyins = { ...window.POKER.buyins };
    const updatedCashouts = { ...window.POKER.cashouts };

    // ATUALIZAR C√ìPIAS
    updatedBuyins[window.POKER.currentCashoutId] = {
      baseBuyin: baseBuyin,
      rebuyCount: rebuyCount,
      totalInvested: totalInvested
    };
    updatedCashouts[window.POKER.currentCashoutId] = cashoutValue;

    // USAR O SETTER (dispara valida√ß√£o e sincroniza√ß√£o)
    window.POKER = {
      buyins: updatedBuyins,
      cashouts: updatedCashouts,
      currentCashoutId: window.POKER.currentCashoutId,
      storage: window.POKER.storage
    };

    console.log('[Storage] Dados sincronizados via setter');
    console.log('[Storage] Buyins:', window.POKER.buyins);
    console.log('[Storage] Cashouts:', window.POKER.cashouts);

    // SALVAR NO SUPABASE - usando storageModule
    if (window.CURRENTUSERID && window.storageModule && typeof window.storageModule.saveCashout === 'function') {
      try {
        await window.storageModule.saveCashout(
          cashoutValue,
          baseBuyin,
          rebuyCount,
          totalInvested
        );
        console.log('[Storage] Cashout salvo no Supabase');
      } catch (error) {
        console.error('[Storage] Erro ao salvar no Supabase:', error);
      }
    } else {
      console.warn('[Storage] storageModule ou User ID n√£o dispon√≠vel, salvando apenas localmente');
    }

    // CHAMAR FUN√á√ïES DE UI
    closeCashoutModal();
    showNotification(
      'Cashout Registrado',
      `Valor ${cashoutValue} com ${rebuyCount} rebuys salvo com sucesso`,
      'success'
    );

    // ATUALIZAR INTERFACE
    renderTable();
    updateControlDashboard();

    if (typeof updateBankrollMetrics === 'function') {
      updateBankrollMetrics();
    }
    // ‚úÖ NOVO: ATUALIZAR BANKROLL IMEDIATAMENTE
    setTimeout(() => {
        if (typeof refreshAllBankrollMetrics === 'function') {
            console.log('[Cashout] Atualizando m√©tricas do bankroll...');
            refreshAllBankrollMetrics();
        }
    }, 500);
    // ‚úÖ NOVO: SALVAR MTRICAS COM DELAY PARA DOM ATUALIZAR
    console.log('[Storage] Aguardando atualiza√ß√£o da DOM antes de salvar m√©tricas...');
    setTimeout(async () => {
      console.log('[Storage] Salvando m√©tricas ap√≥s cashout...');
      if (typeof saveBankrollMetrics === 'function') {
        await saveBankrollMetrics();
      }
    }, 300); // Aguarda 300ms para DOM atualizar


    // SALVAR ESTADO DO USU√ÅRIO
    if (typeof window.saveCurrentUserState === 'function') {
      window.saveCurrentUserState({
        buyins: window.POKER.buyins,
        cashouts: window.POKER.cashouts
      });
    }

    return null;

  } catch (error) {
    console.error('[Storage] Erro ao salvar cashout:', error);
    alert(`Erro ao salvar cashout: ${error.message}`);
  }
};



// ============================================
// 3. DEFINI√á√ÉO √öNICA DE saveCurrentUserState
// ============================================
window.saveCurrentUserState = async function(data) {
    // ‚ö†Ô∏è N√ÉO SALVAR se estiver carregando ou dados ainda n√£o foram carregados
    if (isLoadingData || !dataLoaded) {
        console.log('[Storage] ‚è∏Ô∏è Salvamento bloqueado - aguardando carregamento de dados');
        return;
    }
    
    const initialBank = Number(document.getElementById('bankrollInitialBank')?.value ?? 0);
    const safetyFactor = Number(document.getElementById('bankrollSafetyFactor')?.value ?? 0);
    const stateData = {
        ...data,

        // mant√©m como est√° hoje
        buyins: window.POKER.buyins,
        cashouts: window.POKER.cashouts,
        registered: Array.from(window.registered || []),
        filteredTournaments: window.filteredTournaments,

        // ‚úÖ NOVO: persistir snapshot com date/time do hist√≥rico
        registeredMeta: window.registeredMeta || window.POKER?.registeredMeta || {}
    };

    
    console.log('[Storage] Salvando estado do usu√°rio:', stateData);
    
    if (window.storageModule && typeof window.storageModule.saveUserState === 'function') {
        try {
            const result = await window.storageModule.saveUserState(stateData);
            
            // ‚úÖ Depois de salvar: nada de window.registered (Set legado)
            console.log('[Storage] ‚úÖ Estado salvo. registeredTournaments.size =', window.registeredTournaments?.size || 0);

            // Atualiza UI (badge/tabela do topo/dashboard)
            if (typeof renderRegisteredTournamentsTable === 'function') renderRegisteredTournamentsTable();
            if (typeof updateControlDashboard === 'function') updateControlDashboard();

            
            // ‚≠ê AGORA sim chamar saveBankrollMetrics
            if (typeof saveBankrollMetrics === 'function') {
                console.log('[Storage] Salvando m√©tricas com registered atualizado...');
                await saveBankrollMetrics();
            } else {
                console.warn('[Storage] saveBankrollMetrics n√£o dispon√≠vel');
            }
            
            return result;
        } catch (error) {
            console.error('[Storage] Erro ao salvar estado:', error);
        }
    } else {
        console.warn('[Storage] storageModule.saveUserState n√£o dispon√≠vel');
    }
}


// ============================================
// 4.updateBankroll
// ============================================
window.updateBankroll = async function(amount) {
    console.log('[Storage] updateBankroll chamado com amount:', amount)
    
    if (window.storageModule && typeof window.storageModule.updateBankroll === 'function') {
        try {
            return await window.storageModule.updateBankroll(amount)
        } catch (error) {
            console.error('[Storage] Erro ao atualizar bankroll:', error)
        }
    }
}

// ============================================
// 5.WRAPPERS DE FUN√á√ïES DO storageModule
// ============================================
window.saveCashoutToSupabase = async function(cashoutValue, baseBuyin, rebuyCount, totalInvested) {
    if (window.storageModule && typeof window.storageModule.saveCashout === 'function') {
        try {
            return await window.storageModule.saveCashout(cashoutValue, baseBuyin, rebuyCount, totalInvested)
        } catch (error) {
            console.error('[Storage] Erro ao salvar cashout no Supabase:', error)
            return null
        }
    } else {
        console.error('[Storage] storageModule.saveCashout n√£o dispon√≠vel')
        return null
    }
}

window.saveUsersToStorage = async function(users) {
    if (window.storageModule && typeof window.storageModule.saveUsersToStorage === 'function') {
        try {
            return await window.storageModule.saveUsersToStorage(users)
        } catch (error) {
            console.error('[Storage] Erro ao salvar usu√°rios:', error)
            return null
        }
    }
}

// ============================================
// 7Ô∏è‚É£ INICIALIZAR AO CARREGAR A P√ÅGINA
// ============================================
console.log('[Storage] ‚úÖ Sistema de integra√ß√£o carregado com sucesso')
console.log('[Storage] Aguardando User ID...')

</script>
<script> //BLOCO 3Ô∏è‚É£: UI & DOM FUNCTIONS
    let allTournamentsData = [];
    let selectedDays = new Set([1, 2, 3, 4, 5, 6, 0]);
    let apiOnline = false;
    let profiles = {};
    let sortColumn = null;
    let sortDirection = 'asc';
    let updateInterval = null;

    function calculateTournamentStatus(tournament) {
        const now = new Date();
        const [year, month, day] = tournament.date.split('-');
        const [hours, minutes] = tournament.time.split(':');

        const tournamentDateTime = new Date(year, parseInt(month) - 1, parseInt(day), parseInt(hours), parseInt(minutes));

        // ‚úÖ CORRE√á√ÉO: Calcular quando Late Reg termina
        // Late Reg dura `tournament.lateReg` minutos AP√ìS o in√≠cio
        const lateRegDurationMs = (tournament.lateReg || 30) * 60 * 1000;
        const lateRegEndsAt = new Date(tournamentDateTime.getTime() + lateRegDurationMs);

        // ‚úÖ Se passou do fim de late reg ‚Üí Fechado
        if (lateRegEndsAt < now) {
            return {
                status: 'Fechado',
                timeRemaining: null,
                countdownText: 'Fechado'
            };
        }

        const timeUntilStart = (tournamentDateTime - now) / 1000;
        const timeUntilLateRegClose = (lateRegEndsAt - now) / 1000;

        // ‚úÖ Se come√ßou MAS ainda est√° em late reg
        if (timeUntilStart <= 0 && timeUntilLateRegClose > 0) {
            const countdownText = formatCountdown(timeUntilLateRegClose);
            return {
                status: 'Late Reg',
                timeRemaining: Math.max(0, timeUntilLateRegClose),
                countdownText
            };
        }

        // ‚úÖ Ainda n√£o come√ßou (Aberto)
        const countdownText = formatCountdown(timeUntilStart);
        return {
            status: 'Aberto',
            timeRemaining: null,
            countdownText
        };
    }


    function formatCountdown(seconds) {
        const s = Math.max(0, Math.floor(seconds));
        const hours = Math.floor(s / 3600);
        const minutes = Math.floor((s % 3600) / 60);
        const secs = s % 60;

        if (hours > 0) {
            return `${hours}h ${minutes}m`;
        } else if (minutes > 0) {
            return `${minutes}m ${secs}s`;
        } else {
            return `${secs}s`;
        }
    }

    function renderStatusWithCountdown(tournament) {
        const info = calculateTournamentStatus(tournament);
        const cls = `status-${info.status.toLowerCase().replace(' ', '-')}`;
        return `
            <div class="countdown-container">
                <span class="status-badge ${cls}">${info.status}</span>
                <span class="countdown-badge">‚è±Ô∏è ${info.countdownText}</span>
            </div>
        `;
    }

    function toggleSection(element) {
        element.classList.toggle('collapsed');
        const content = element.nextElementSibling;
        content.classList.toggle('collapsed');
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        sidebar.classList.toggle('open');
        mainContent.classList.toggle('sidebar-open');
    }

    function loadProfiles() {
        const saved = localStorage.getItem('pokerProfiles');
        profiles = saved ? JSON.parse(saved) : {};
        renderProfilesList();
    }

    function saveProfilesToStorage() {
        localStorage.setItem('pokerProfiles', JSON.stringify(profiles));
    }

    function renderProfilesList() {
        const container = document.getElementById('profilesList');
        if (Object.keys(profiles).length === 0) {
            container.innerHTML = '<div style="font-size: 11px; color: var(--text-secondary); text-align: center; padding: 10px;">Nenhum perfil salvo</div>';
            return;
        }

        container.innerHTML = Object.keys(profiles).map(name => `
            <div style="display: flex; gap: 6px; margin-bottom: 8px;">
                <button class="btn-primary" onclick="loadProfile('${name}')" style="flex: 1; padding: 6px; font-size: 11px; margin-top: 0;">üìÇ ${name}</button>
                <button class="btn-primary" onclick="deleteProfile('${name}')" style="flex: 0; width: auto; padding: 6px 8px; background: var(--danger); margin-top: 0;">‚ùå</button>
            </div>
        `).join('');
    }

    function saveCurrentProfile() {
        const name = document.getElementById('profileName').value.trim();
        if (!name) {
            showNotification('‚ö†Ô∏è Aviso', 'Digite um nome para o perfil', 'warning');
            return;
        }

        if (profiles[name]) {
            showNotification('‚ö†Ô∏è Aviso', 'Perfil com este nome j√° existe', 'warning');
            return;
        }

        profiles[name] = {
            days: Array.from(selectedDays),
            rooms: Array.from(document.querySelectorAll('.room-filter:checked')).map(e => e.value),
            types: Array.from(document.querySelectorAll('.type-filter:checked')).map(e => e.value),
            priorities: Array.from(document.querySelectorAll('.priority-filter:checked')).map(e => e.value),
            statuses: Array.from(document.querySelectorAll('.status-filter:checked')).map(e => e.value),
            minBuyin: document.getElementById('minBuyin').value,
            maxBuyin: document.getElementById('maxBuyin').value,
            minGuaranteed: document.getElementById('minGuaranteed').value,
            maxGuaranteed: document.getElementById('maxGuaranteed').value
        };

        saveProfilesToStorage();
        renderProfilesList();
        document.getElementById('profileName').value = '';
        showNotification('‚úÖ Salvo!', `Perfil "${name}" salvo com sucesso`, 'success');
    }

    function loadProfile(name) {
        const profile = profiles[name];
        if (!profile) return;

        selectedDays = new Set(profile.days);
        document.querySelectorAll('.weekday-btn').forEach(btn => {
            const day = parseInt(btn.dataset.day);
            if (selectedDays.has(day)) btn.classList.add('active');
            else btn.classList.remove('active');
        });

        document.querySelectorAll('.room-filter').forEach(el => {
            el.checked = profile.rooms.includes(el.value);
        });
        document.querySelectorAll('.type-filter').forEach(el => {
            el.checked = profile.types.includes(el.value);
        });
        document.querySelectorAll('.priority-filter').forEach(el => {
            el.checked = profile.priorities.includes(el.value);
        });
        document.querySelectorAll('.status-filter').forEach(el => {
            el.checked = (profile.statuses || []).includes(el.value);
        });

        document.getElementById('minBuyin').value = profile.minBuyin || 0;
        document.getElementById('maxBuyin').value = profile.maxBuyin || 500;
        document.getElementById('minGuaranteed').value = profile.minGuaranteed || 0;
        document.getElementById('maxGuaranteed').value = profile.maxGuaranteed || 999999;

        applyFilters();
        showNotification('üìÇ Carregado!', `Perfil "${name}" carregado com sucesso`, 'success');
    }

    function deleteProfile(name) {
        if (confirm(`Tem certeza que deseja deletar o perfil "${name}"?`)) {
            delete profiles[name];
            saveProfilesToStorage();
            renderProfilesList();
            showNotification('üóëÔ∏è Deletado', `Perfil "${name}" foi removido`, 'warning');
        }
    }

    // ===== Pagina√ß√£o de torneios (NOVO) =====
const TOURNAMENTS_PAGE_SIZE = 50;

window.TOURNAMENTS_PAGINATION = {
  page: 0,
  limit: TOURNAMENTS_PAGE_SIZE,
  day: null,        // YYYY-MM-DD (Brasil)
  total: 0,
  totalPages: 0,
  hasNext: true,
  loading: false
};

// Passo 5: "hoje" no fuso do Brasil (America/Sao_Paulo)
function getBrazilYYYYMMDD(date = new Date()) {
  // Gera YYYY-MM-DD usando o timezone do Brasil
  const parts = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'America/Sao_Paulo',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).formatToParts(date);

  const y = parts.find(p => p.type === 'year')?.value;
  const m = parts.find(p => p.type === 'month')?.value;
  const d = parts.find(p => p.type === 'day')?.value;
  return `${y}-${m}-${d}`;
}

function updatePageInfo() {
  const info = document.getElementById('pageInfo');
  const btn = document.getElementById('btnLoadMore');
  const p = window.TOURNAMENTS_PAGINATION;

  if (info) {
    const dayLabel = p.day || getBrazilYYYYMMDD();
    const loaded = (window.allTournamentsData?.length || 0);
    const total = p.total || 0;
    const pageText = p.page > 0 ? `P√°gina ${p.page}/${p.totalPages || 1}` : 'P√°gina 0';
    info.textContent = `Dia ${dayLabel} ‚Ä¢ ${pageText} ‚Ä¢ Carregados ${loaded} de ${total}`;
  }

  if (btn) {
    btn.disabled = !p.hasNext || p.loading;
    btn.textContent = p.loading ? 'Carregando...' : (p.hasNext ? 'Carregar mais' : 'Sem mais torneios');
  }
}

// ‚úÖ Nova fun√ß√£o: busca UMA p√°gina do backend
async function fetchTournamentsPage(page) {
  const limit = window.TOURNAMENTS_PAGINATION?.limit || 50;

  const fixedDateValue = document.getElementById('fixedDate')?.value;

  const params = new URLSearchParams();
  params.set('page', String(page));
  params.set('limit', String(limit));

  if (fixedDateValue) {
    // quando o usu√°rio escolhe uma data, pe√ßa exatamente aquela data
    params.set('date', fixedDateValue);
  } else {
    // padr√£o: √∫ltimos 2 dias
    params.set('days', '2');
  }

  const res = await fetch(`/api/tournaments?${params.toString()}`);
  const json = await res.json();

  if (!json?.success) throw new Error(json?.error || 'API retornou success=false');
  return json;
}


async function loadTournamentsFromAPI({ reset = false } = {}) {
  try {
    if (window.TOURNAMENTS_PAGINATION.loading) return [];

    // Reset geral (primeira carga ou clique em "Hoje")
    if (reset) {
      window.TOURNAMENTS_PAGINATION.page = 0;
      window.TOURNAMENTS_PAGINATION.hasNext = true;
      window.TOURNAMENTS_PAGINATION.total = 0;
      window.TOURNAMENTS_PAGINATION.totalPages = 0;
      window.allTournamentsData = [];
      window.filteredTournaments = [];
    }

    // Pr√≥xima p√°gina
    const nextPage = window.TOURNAMENTS_PAGINATION.page + 1;
    window.TOURNAMENTS_PAGINATION.loading = true;
    updatePageInfo();

    const payload = await fetchTournamentsPage(nextPage);

    // Normaliza seus torneios no formato que o app espera
    const tournaments = (payload.tournaments || []).map((t, idx) => {
      const yearMonthDay = (t.date || '1970-01-01').split('-');
      const year = yearMonthDay[0];
      const month = yearMonthDay[1];
      const day = yearMonthDay[2];

      const dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
      const dayOfWeek = dateObj.getDay();

      return {
        id: t.id ?? (idx + 1),
        time: t.time || '00:00',
        date: t.date,
        site: t.site || 'GGPoker',
        name: t.name || 'Torneio',
        type: (t.type || 'REG').toUpperCase(),
        buyin: parseFloat(t.buyin || 0),
        guaranteed: parseFloat(t.guaranteed || 0),
        field: parseInt(t.field || 0),
        lateReg: parseInt(t.lateReg || 0),
        status: t.status || 'Aberto',
        priority: t.priority || 'medium',
        day: dayOfWeek
      };
    });

    // Atualiza estado global
    window.TOURNAMENTS_PAGINATION.page = payload.pagination?.page ?? nextPage;
    window.TOURNAMENTS_PAGINATION.total = payload.pagination?.total ?? tournaments.length;
    window.TOURNAMENTS_PAGINATION.totalPages = payload.pagination?.totalPages ?? 1;
    window.TOURNAMENTS_PAGINATION.hasNext = payload.pagination?.hasNext ?? false;

    // Concatena no array total
    window.allTournamentsData = (window.allTournamentsData || []).concat(tournaments);

    // Aqui √© importante: o seu app usa applyFilters() para criar window.filteredTournaments
    // ent√£o guardamos allTournamentsData e chamamos applyFilters.
    updateAPIStatus(true);

    // Rodar filtros e render
    if (typeof applyFilters === 'function') {
      applyFilters();
    } else {
      window.filteredTournaments = window.allTournamentsData;
      renderTable();
      updateControlDashboard();
    }

    // Atualizar UI de pagina√ß√£o
    updatePageInfo();

    return tournaments;

  } catch (error) {
    updateAPIStatus(false, error.message);
    showNotification('Aviso', `Erro ao carregar torneios: ${error.message}`, 'warning');
    console.error('[API] loadTournamentsFromAPI error:', error);
    updatePageInfo();
    return [];
  } finally {
    window.TOURNAMENTS_PAGINATION.loading = false;
    updatePageInfo();
  }
}

// Expor a√ß√µes globais para os bot√µes
window.nextTournamentsPage = async function() {
  const p = window.TOURNAMENTS_PAGINATION;
  if (!p.hasNext || p.loading) return;
  await loadTournamentsFromAPI({ reset: false });
};

window.resetTournamentsPagination = async function() {
  // fixa o dia como HOJE (Brasil)
  window.TOURNAMENTS_PAGINATION.day = getBrazilYYYYMMDD();
  await loadTournamentsFromAPI({ reset: true });
};


    function updateAPIStatus(online, message = '') {
        apiOnline = online;
        const statusEl = document.getElementById('apiStatus');
        if (online) {
            statusEl.className = 'api-status online';
            statusEl.textContent = '‚úÖ Online';
        } else {
            statusEl.className = 'api-status offline';
            statusEl.textContent = '‚ùå Offline - ' + (message || 'Erro desconhecido');
        }
    }

    function getMockTournaments() {
        const now = new Date();
        const todayStr = now.toISOString().slice(0,10);
        const tomorrow = new Date(now); tomorrow.setDate(now.getDate() + 1);
        const tomorrowStr = tomorrow.toISOString().slice(0,10);

        return [
            { id: 1, time: '20:30', date: todayStr, site: 'GGPoker', name: 'Daily Hyper $20', type: 'HYPER', buyin: 20, guaranteed: 7000, field: 0, lateReg: 30, status: 'Aberto', priority: 'medium', day: now.getDay() },
            { id: 2, time: '21:00', date: todayStr, site: 'GGPoker', name: 'Bounty $50', type: 'TURBO KO', buyin: 50, guaranteed: 30000, field: 0, lateReg: 45, status: 'Aberto', priority: 'high', day: now.getDay() },
            { id: 3, time: '19:30', date: tomorrowStr, site: 'PokerStars', name: 'Sunday Special', type: 'REG', buyin: 11, guaranteed: 10000, field: 0, lateReg: 60, status: 'Aberto', priority: 'very-high', day: tomorrow.getDay() },
        ];
    }

    async function initializeApp() {
        loadProfiles();
        
        // Carrega 1¬™ p√°gina (hoje BR)
        await window.resetTournamentsPagination();

        setupEventListeners();
        updateControlDashboard();

        if (updateInterval) clearInterval(updateInterval);
        updateInterval = setInterval(() => {
            document.querySelectorAll('tr[data-tournament-row-id]').forEach(row => {
                const id = parseInt(row.dataset.tournamentRowId);
                const t = window.filteredTournaments.find(x => x.id === id);
                if (!t) return;
                const statusCell = row.querySelector('[data-status-cell]');
                if (statusCell) statusCell.innerHTML = renderStatusWithCountdown(t);
            });
        }, 1000);
    }

    function setupEventListeners() {
        document.querySelectorAll('.weekday-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const day = parseInt(e.target.dataset.day);
                if (selectedDays.has(day)) {
                    selectedDays.delete(day);
                    e.target.classList.remove('active');
                } else {
                    selectedDays.add(day);
                    e.target.classList.add('active');
                }
                applyFilters();
            });
        });

        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));

                e.target.classList.add('active');
                const viewId = e.target.dataset.view;
                const viewEl = document.getElementById(viewId + 'View');
                if (viewEl) {
                    viewEl.classList.remove('hidden');
                }

                // Quando clicar na aba Bankroll, recalcula tudo
                if (viewId === 'bankroll') {
                    updateBankroll();
                }
            });
        });


        document.getElementById('applyFilters').addEventListener('click', applyFilters);

        document.getElementById('reloadAPI').addEventListener('click', async () => {
            await window.resetTournamentsPagination();
            showNotification('Atualizado', 'Primeira p√°gina de hoje recarregada.', 'success');
        });


        document.getElementById('saveProfile').addEventListener('click', saveCurrentProfile);

        document.getElementById('fixedDate')?.addEventListener('change', async () => {
            await loadTournamentsFromAPI({ reset: true }); // isso vai chamar fetchTournamentsPage() e repovoar allTournamentsData
        });


        document.querySelectorAll('.room-filter, .type-filter, .priority-filter, .status-filter').forEach(el => {
            el.addEventListener('change', applyFilters);
        });

        document.getElementById('minBuyin').addEventListener('input', applyFilters);
        document.getElementById('maxBuyin').addEventListener('input', applyFilters);
        document.getElementById('minGuaranteed').addEventListener('input', applyFilters);
        document.getElementById('maxGuaranteed').addEventListener('input', applyFilters);

        document.querySelectorAll('th[data-column]').forEach(th => {
            th.addEventListener('click', e => {
                const column = e.target.dataset.column;
                if (sortColumn === column) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                applyFilters();
            });
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeCashoutModal();
        });
        // No setupEventListeners():
        document.getElementById('rebuyCount').addEventListener('input', updateInvestedAmount);
    
    }

    function getMergedTournamentsSource() {
        const api = Array.isArray(window.allTournamentsData) ? window.allTournamentsData : [];
        const manual = Array.isArray(window.manualTournaments) ? window.manualTournaments : [];

        // dedupe por id
        const map = new Map();
        [...api, ...manual].forEach(t => map.set(Number(t.id), t));
        return Array.from(map.values());
    }    
    window.allTournamentsData = mergeTournamentsById(window.allTournamentsData, window.manualTournaments);

    function applyFilters() {     
        const source = getMergedTournamentsSource();
        const rooms = Array.from(document.querySelectorAll('.room-filter:checked')).map(e => e.value);
        const types = Array.from(document.querySelectorAll('.type-filter:checked')).map(e => e.value);
        const priorities = Array.from(document.querySelectorAll('.priority-filter:checked')).map(e => e.value);
        const statuses = Array.from(document.querySelectorAll('.status-filter:checked')).map(e => e.value);
        const minBuyin = parseInt(document.getElementById('minBuyin').value) || 0;
        const maxBuyin = parseInt(document.getElementById('maxBuyin').value) || 999999;
        const minGuaranteed = parseInt(document.getElementById('minGuaranteed').value) || 0;
        const maxGuaranteed = parseInt(document.getElementById('maxGuaranteed').value) || 999999;
        const fixedDateValue = document.getElementById('fixedDate').value;        
        const today = new Date();
        const twoDaysAgo = new Date(today); twoDaysAgo.setDate(today.getDate() - 2);
        const twoDaysAgoFormatted = `${twoDaysAgo.getFullYear()}-${String(twoDaysAgo.getMonth()+1).padStart(2,'0')}-${String(twoDaysAgo.getDate()).padStart(2,'0')}`;
        window.filteredTournaments = source.filter(t => {
            const statusInfo = calculateTournamentStatus(t);
            t.status = statusInfo.status;
            t.timeRemaining = statusInfo.timeRemaining;

       
            const isRegistered = window.registeredTournaments?.has(Number(t.id)) || false;        
            if (isRegistered) {
                return rooms.includes(t.site) &&
                    types.includes(t.type) &&
                    priorities.includes(t.priority) &&
                    t.buyin >= minBuyin &&
                    t.buyin <= maxBuyin &&
                    t.guaranteed >= minGuaranteed &&
                    t.guaranteed <= maxGuaranteed;
            }   
            let matchDate = false;
                if (fixedDateValue) {
                    // Se TEM filtro de data: mostra apenas essa data exata
                    matchDate = t.date === fixedDateValue;
                } else {
                    // Se N√ÉO TEM filtro: mostra √∫ltimos 2 dias
                    matchDate = t.date >= twoDaysAgoFormatted;
                }

                return rooms.includes(t.site) &&
                    types.includes(t.type) &&
                    priorities.includes(t.priority) &&
                    statuses.includes(statusInfo.status) &&  // ‚Üê IMPORTANTE: Verifica status
                    t.buyin >= minBuyin &&
                    t.buyin <= maxBuyin &&
                    t.guaranteed >= minGuaranteed &&
                    t.guaranteed <= maxGuaranteed &&
                    selectedDays.has(t.day) &&  // ‚Üê IMPORTANTE: Verifica dia
                    matchDate;
            });

        if (sortColumn && sortColumn !== 'time' && sortColumn !== 'date') {
            window.filteredTournaments.sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];

                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;

                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.time.localeCompare(b.time);
            });
        } else if (sortColumn === 'time') {
            window.filteredTournaments.sort((a, b) => {
                if (a.time !== b.time)
                    return sortDirection === 'asc' ? a.time.localeCompare(b.time) : b.time.localeCompare(a.time);
                return sortDirection === 'asc' ? a.date.localeCompare(b.date) : b.date.localeCompare(a.date);
            });
        } else if (sortColumn === 'date') {
            window.filteredTournaments.sort((a, b) => {
                if (a.date !== b.date)
                    return sortDirection === 'asc' ? a.date.localeCompare(b.date) : b.date.localeCompare(a.date);
                return sortDirection === 'asc' ? a.time.localeCompare(b.time) : b.time.localeCompare(a.time);
            });
        } else {
            window.filteredTournaments.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.time.localeCompare(b.time);
            });
        }

        renderTable();
        updateControlDashboard();
    }

    function renderTable() {
        renderRegisteredTournamentsTable();
        const tbody = document.getElementById('tournamentBody');

        document.querySelectorAll('th[data-column]').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.dataset.column === sortColumn) th.classList.add(`sort-${sortDirection}`);
        });

        const priorityLabels = {
            'very-low': 'Very Low',
            'low': 'Low',
            'medium': 'Medium',
            'high': 'High',
            'very-high': 'Very High'
        };

        tbody.innerHTML = window.filteredTournaments.map(t => {
            const typeClass = t.type.toLowerCase().replace(' ', '-');

            return `
                <tr data-tournament-row-id="${t.id}" class="${window.registeredTournaments.has(t.id) ? 'registered' : ''}">
                    <td><span style="color: var(--secondary); font-weight: 700;">${t.time}</span></td>
                    <td><span style="color: var(--text-secondary);">${t.date}</span></td>
                    <td><span class="site-badge site-${t.site.toLowerCase().replace(/\s/g, '')}">${t.site}</span></td>
                    <td><span style="color: var(--secondary); font-weight: 600;">${t.name}</span></td>
                    <td><span class="badge badge-${typeClass}">${t.type}</span></td>
                    <td>$${t.buyin}</td>
                    <td>$${(t.guaranteed / 1000).toFixed(0)}K</td>
                    <td>${t.field}</td>
                    <td><span class="badge badge-priority badge-${t.priority}">${priorityLabels[t.priority]}</span></td>
                    <td data-status-cell>${renderStatusWithCountdown(t)}</td>
                    <td><button class="btn-register ${window.registeredTournaments.has(t.id) ? 'active' : ''}" data-id="${t.id}">${window.registeredTournaments.has(t.id) ? '‚úÖ Registrado' : 'Registrar'}</button></td>
                    <td><button class="btn-cashout ${!window.registeredTournaments.has(t.id) ? 'disabled' : ''}" onclick="openCashoutModal(${t.id})" ${!window.registeredTournaments.has(t.id) ? 'disabled' : ''}>üí∞ Cashout</button></td>
                </tr>
            `;
        }).join('');

        document.querySelectorAll('.btn-register').forEach(btn => {
            btn.addEventListener('click', e => {
                const id = parseInt(e.target.dataset.id);
                toggleRegister(id);
                updateControlDashboard();
            });
        });
    }
// WRAPPER PARA renderTable - SEM SALVAMENTOS AUTOM√ÅTICOS
const origRenderTable = window.renderTable;
window.renderTable = async function() {
    try {
        // 1Ô∏è‚É£ ‚úÖ PROTE√á√ÉO: Inicializar estruturas
        if (!window.registeredTournaments) {
            window.registeredTournaments = new Map();
        }
        if (!window.filteredTournaments) {
            window.filteredTournaments = [];
        }
        if (!window.buyins) {
            window.buyins = {};
        }
        if (!window.cashouts) {
            window.cashouts = {};
        }

        // 1Ô∏è‚É£ RENDERIZAR A TABELA
        origRenderTable();
        
        // 2Ô∏è‚É£ CALCULAR M√âTRICAS
        if (typeof updateBankrollMetrics === 'function') {
            updateBankrollMetrics();
        }
        
        // 3Ô∏è‚É£ ‚≠ê SINCRONIZAR DOM
        // ‚úÖ CORRE√á√ÉO 1: registeredTournaments ao inv√©s de registered
        const registeredTournaments = Array.from(window.registeredTournaments.values())
            .filter(t => t && window.cashouts[t.id] !== undefined);
        
        console.log('[Render] Torneios registrados:', registeredTournaments.length);

        if (registeredTournaments.length > 0) {
            // ‚úÖ CORRE√á√ÉO 2: Valores num√©ricos seguros
            const totalBuyin = registeredTournaments.reduce((sum, t) => {
                const invested = (window.buyins[t.id]?.totalInvested || t.buyin || 0);
                return sum + Number(invested);
            }, 0);
            
            const totalCashout = registeredTournaments.reduce((sum, t) => 
                sum + Number(window.cashouts[t.id] || 0), 0);
            
            const totalProfit = totalCashout - totalBuyin;
            const roi = totalBuyin > 0 ? (totalProfit / totalBuyin) * 100 : 0;
            const avgBuyin = registeredTournaments.length > 0 ? totalBuyin / registeredTournaments.length : 0;
            
            // ‚úÖ CORRE√á√ÉO 3: ITM seguro
            const itmCount = registeredTournaments.filter(t => {
                const invested = Number(window.buyins[t.id]?.totalInvested || t.buyin || 0);
                const cashout = Number(window.cashouts[t.id] || 0);
                return cashout > invested;
            }).length;
            const itmPercent = registeredTournaments.length > 0 ? (itmCount / registeredTournaments.length) * 100 : 0;
            
            // Atualizar DOM
            const updateElement = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            
            updateElement('bankrollTotalTournaments', registeredTournaments.length);
            updateElement('bankrollAvgBuyin', '$' + avgBuyin.toFixed(2));
            updateElement('bankrollTotalProfit', '$' + totalProfit.toFixed(2));
            updateElement('bankrollROI', roi.toFixed(2) + '%');
            updateElement('bankrollITM', itmPercent.toFixed(2) + '%');
            updateElement('bankrollPrizeTotal', '$' + totalCashout.toFixed(2));
            
            // Cor do profit
            const profitEl = document.getElementById('bankrollTotalProfit');
            if (profitEl) {
                profitEl.style.color = totalProfit >= 0 ? 'var(--success)' : 'var(--danger)';
            }

            // Banca atual
            const initialBank = Number(document.getElementById('bankrollInitialBank')?.value || 1000);
            const currentBank = initialBank + totalProfit;
            const currentBankEl = document.getElementById('bankrollCurrentBank');
            if (currentBankEl) {
                currentBankEl.textContent = '$' + currentBank.toFixed(2);
                currentBankEl.style.color = currentBank >= initialBank ? 'var(--success)' : 'var(--danger)';
            }
            
            // ABI ideal
            const safetyFactor = Number(document.getElementById('bankrollSafetyFactor')?.value || 400);
            const idealABI = initialBank / safetyFactor;
            updateElement('bankrollIdealABI', '$' + idealABI.toFixed(2));
            
        } else {
            // Limpar dashboard
            const elementsToClear = [
                'bankrollTotalTournaments', 'bankrollAvgBuyin', 'bankrollTotalProfit',
                'bankrollROI', 'bankrollITM', 'bankrollPrizeTotal', 'bankrollCurrentBank'
            ];
            elementsToClear.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '0';
            });
        }
        
        // 4Ô∏è‚É£ Salvar m√©tricas
        await new Promise(resolve => setTimeout(resolve, 100));
        if (typeof saveBankrollMetrics === 'function') {
            saveBankrollMetrics();
        }
        
    } catch (error) {
        console.error('[Storage] Erro em renderTable wrapper:', error);
    }
};



    function renderRegisteredTournamentsTable() {
        // ‚úÖ PROTE√á√ÉO: Inicializar se n√£o existir
        if (!window.registeredTournaments) {
            console.log('[Render] ‚ö†Ô∏è registeredTournaments n√£o existe, inicializando...');
            window.registeredTournaments = new Map();
        }

        // ‚úÖ CORRE√á√ÉO: Usar registeredTournaments ao inv√©s de registered
        const registeredTournaments = Array.from(window.registeredTournaments.values())
            .filter(t => t); // Filtrar valores v√°lidos

        const tbody = document.getElementById('registeredTournamentsBody');
        const badge = document.getElementById('registeredCountBadge');

        // Atualizar badge
        if (badge) {
            badge.textContent = registeredTournaments.length;
        }

        // Caso n√£o tenha tbody (elemento n√£o existe)
        if (!tbody) {
            console.warn('[Render] ‚ö†Ô∏è Elemento registeredTournamentsBody n√£o encontrado');
            return;
        }

        // ‚úÖ Tabela vazia
        if (registeredTournaments.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        Nenhum torneio registrado ainda. Clique em "Registrar" na tabela abaixo.
                    </td>
                </tr>
            `;
            return;
        }

        // ‚úÖ Renderizar torneios registrados
        tbody.innerHTML = registeredTournaments.map(t => {
            // ‚úÖ Prote√ß√£o: Verificar se buyins e cashouts existem
            const buyins = window.buyins || {};
            const cashouts = window.cashouts || {};
            
            const baseBuyin = t.buyin || 0;
            const rebuyData = buyins[t.id] || {};
            const rebuyCount = rebuyData.rebuyCount ?? 0;
            const totalInvested = rebuyData.totalInvested ?? baseBuyin;
            const cashout = cashouts[t.id] ?? 0;
            const profit = cashout - totalInvested;

            const profitColor = profit >= 0 ? 'var(--success)' : 'var(--danger)';

            return `
                <tr style="border-bottom: 1px solid var(--border); background: rgba(201, 169, 97, 0.02);">
                    <td style="padding: 8px 10px; color: var(--text-secondary);">${t.time || '-'}</td>
                    <td style="padding: 8px 10px; color: var(--text-primary); font-weight: 600;">${t.name || 'Sem nome'}</td>
                    <td style="padding: 8px 10px; text-align: center; color: var(--text-secondary);">$${baseBuyin}</td>
                    <td style="padding: 8px 10px; text-align: center; color: var(--secondary); font-weight: 600;">
                        ${rebuyCount > 0 ? `+${rebuyCount}` : '-'}
                    </td>
                    <td style="padding: 8px 10px; text-align: center; color: var(--text-primary); font-weight: 600;">
                        $${totalInvested.toFixed(2)}
                    </td>
                    <td style="padding: 8px 10px; text-align: center; color: var(--text-primary); font-weight: 600;">
                        ${cashout >= 0 ? '$' + cashout.toFixed(2) : '‚è≥'}
                    </td>
                    <td style="padding: 8px 10px; text-align: center; color: ${profitColor}; font-weight: 600;">
                        ${cashout >= 0 ? '$' + profit.toFixed(2) : '-'}
                    </td>
                    <td style="padding: 8px 10px; text-align: center;">
                        <button class="btn-cashout" onclick="openCashoutModal(${t.id})"
                                style="padding: 4px 8px; font-size: 10px;">
                            ${cashout > 0 ? '‚úèÔ∏è Editar' : 'üí∞ Cashout'}
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
   
    window.ensureCurrentSession = function () {
        if (
            window.currentSession &&
            Array.isArray(window.currentSession.tournamentIds)
        ) return;

        window.currentSession = {
            id: crypto?.randomUUID ? crypto.randomUUID() : `sess-${Date.now()}`,
            startedAt: new Date().toISOString(),
            tournamentIds: []
        };
    };

    async function toggleRegister(id) {
        const tid = Number(id);

        if (!window.registeredMeta || typeof window.registeredMeta !== 'object') window.registeredMeta = {};
        if (!(window.registeredTournaments instanceof Map)) window.registeredTournaments = new Map();
        if (!window.buyins) window.buyins = {};
        if (!window.cashouts) window.cashouts = {};
      
        const t =
            (window.filteredTournaments || []).find(x => Number(x.id) === tid) ||
            (window.allTournamentsData || []).find(x => Number(x.id) === tid) ||
            null;

        const hasCashoutKey = Object.prototype.hasOwnProperty.call(window.cashouts, tid);
        const isPending = hasCashoutKey && window.cashouts[tid] === null;       // ‚úÖ pendente s√≥ null
        const isFinalized = hasCashoutKey && window.cashouts[tid] !== null;     // ‚úÖ inclui 0, 1, 10...


        if (isPending) {
            // estava pendente -> desregistrar
            delete window.cashouts[tid];
            delete window.buyins[tid];
            delete window.registeredMeta[tid];
            window.registeredTournaments.delete(tid);
            // >>> REMOVER DA SESS√ÉO ATUAL
            ensureCurrentSession();
            window.currentSession.tournamentIds =
                (window.currentSession.tournamentIds || []).filter(id => Number(id) !== Number(tid));
            // <<<
        } else if (isFinalized) {
            // j√° tem cashout (0 ou >0) -> n√£o √© pendente
            showNotification('Aviso', 'Este torneio j√° tem cashout (incluindo 0).', 'warning');
            return;
        } else {
            // n√£o existe -> registrar como pendente
            window.cashouts[tid] = null;
            window.buyins[tid] = {
                baseBuyin: Number(t?.buyin ?? 0),
                rebuyCount: 0,
                totalInvested: Number(t?.buyin ?? 0),
            };
            ensureCurrentSession();
            if (!window.currentSession.tournamentIds.includes(tid)){
                window.currentSession.tournamentIds.push(tid);
            }
            window.registeredMeta[tid] = t ? {
                id: tid,
                name: t.name,
                site: t.site,
                type: t.type,
                buyin: Number(t.buyin ?? 0),
                date: t.date,
                time: t.time,
            } : { id: tid };

            window.registeredTournaments.set(tid, window.registeredMeta[tid]);
        }
        // ‚úÖ PASSO 2: salvar estado completo (inclui registeredMeta) imediatamente ap√≥s a altera√ß√£o
        if (typeof window.saveCurrentUserState === 'function') {
            await window.saveCurrentUserState({
            registeredMeta: window.registeredMeta,  // garante que vai no payload
            buyins: window.buyins,                  // opcional, mas ajuda a ficar expl√≠cito
            cashouts: window.cashouts               // opcional, mas ajuda a ficar expl√≠cito
            });
        }

        renderTable();

    }

    function updateControlDashboard() {
        const buyins = window.buyins || {};
        const cashouts = window.cashouts || {};

        // ‚úÖ ADICIONAR ESTA PROTE√á√ÉO
        console.log('[Dashboard] Atualizando dashboard de controle...');
    
        try {
            // ‚úÖ PROTE√á√ÉO 1: registeredTournaments
            if (!window.registeredTournaments) {
                console.log('[Dashboard] ‚ö†Ô∏è registeredTournaments n√£o existe, inicializando...');
                window.registeredTournaments = new Map();
            }

            // ‚úÖ PROTE√á√ÉO 2: filteredTournaments
            if (!window.filteredTournaments) {
                console.log('[Dashboard] ‚ö†Ô∏è filteredTournaments n√£o existe, inicializando...');
                window.filteredTournaments = [];
            }

            // ‚úÖ CORRE√á√ÉO: Usar .values() do Map
            //const registered = Array.from(window.registeredTournaments.values());
            const allIds = Object.keys(window.buyins || {}).map(Number);
            const registered = allIds.map(id => getTournamentForHistory(id)).filter(Boolean);

            
            // Atualizar badge
            const badge = document.getElementById('registeredCountBadge');
            if (badge) {
                badge.textContent = registered.length;
            }

            // ‚úÖ PROTE√á√ÉO 3: Verificar se h√° torneios antes de calcular
            if (registered.length === 0) {
                console.log('[Dashboard] Nenhum torneio registrado, dashboard limpo');
                return;
            }
            // Total investido (considerando rebuys)
            const totalBuyin = registered.reduce((sum, t) => {
            const invested = window.buyins?.[t.id]?.totalInvested ?? t.buyin ?? 0;
            return sum + Number(invested);
            }, 0);

            // Total cashout (s√≥ quando est√° definido, sen√£o usa 0)
            const totalCashoutVal = registered.reduce((sum, t) => {
            const v = window.cashouts?.[t.id];
            return sum + (v === null || v === undefined ? 0 : Number(v));
            }, 0);

            const profit = totalCashoutVal - totalBuyin;
            const roi = totalBuyin > 0 ? (profit / totalBuyin * 100).toFixed(1) : 0;

            // ===== ATUALIZAR DASHBOARD CARDS =====
            document.getElementById('dashTournamentsTotal').textContent = window.filteredTournaments.length;
            document.getElementById('dashRegistered').textContent = registered.length;
            document.getElementById('dashTotalBuyin').textContent = totalBuyin.toFixed(2);
            document.getElementById('dashTotalCashout').textContent = totalCashoutVal.toFixed(2);

            // Lucro/Preju√≠zo com cor
            const profitElement = document.getElementById('dashProfit');
            const profitROI = document.getElementById('dashProfitROI');
            profitElement.textContent = profit.toFixed(2);
            profitElement.style.color = profit > 0 ? 'var(--success)' : profit < 0 ? 'var(--danger)' : 'var(--text-primary)';
            profitROI.textContent = `ROI: ${roi}%`;

            // Mostrar/esconder bot√µes de exporta√ß√£o
            const exportButtons = document.getElementById('exportButtons');
            exportButtons.style.display = registered.length > 0 ? 'flex' : 'none';

            // ===== TABELA DE HIST√ìRICO =====
            const historyContainer = document.getElementById('historyContainer');
            
            if (registered.length > 0) {
                historyContainer.innerHTML = `
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Torneio</th>
                                <th>Sala</th>
                                <th>Tipo</th>
                                <th>Buy-in</th>
                                <th>Rebuy</th>
                                <th>Investido</th>
                                <th>Cashout</th>
                                <th>Resultado</th>
                                <th>ROI</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${registered.map((t, idx) => {
                                // ‚¨áÔ∏è NOVO: calcular dados com rebuy
                                const baseBuyin = t.buyin;
                                const rebuyData = buyins[t.id] || {};
                                const rebuyCount = rebuyData.rebuyCount ?? 0;
                                const totalInvested = rebuyData.totalInvested ?? baseBuyin;
                                
                                const cashout = cashouts[t.id] !== undefined ? cashouts[t.id] : null;
                                
                                let resultado = '-';
                                let roiLine = '-';
                                let resultColor = '';
                                
                                if (cashout !== null) {
                                    resultado = (cashout - totalInvested).toFixed(2);
                                    roiLine = totalInvested > 0 ? (resultado / totalInvested * 100).toFixed(1) : '-';
                                    resultColor = resultado >= 0 ? 'positive' : 'negative';
                                }
                                
                                return `
                                    <tr style="background: ${idx % 2 === 0 ? 'rgba(255,255,255,0.01)' : 'transparent'}">
                                        <td>${t.name}</td>
                                        <td>${t.site}</td>
                                        <td>${t.type}</td>
                                        <td>$${baseBuyin}</td>
                                        <td style="text-align: center; color: var(--secondary); font-weight: 600;">
                                            ${rebuyCount > 0 ? '+' + rebuyCount : '-'}
                                        </td>
                                        <td style="font-weight: 600;">$${totalInvested.toFixed(2)}</td>
                                        <td>${cashout !== null ? '$' + cashout.toFixed(2) : '‚è≥'}</td>
                                        <td class="${resultColor}">${resultado}</td>
                                        <td class="${resultColor}">${roiLine}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                historyContainer.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px; text-align: center; padding: 20px;">Nenhum torneio registrado ainda</div>';
            }
            console.log('[Dashboard] ‚úÖ Dashboard atualizado');

        } catch (error) {
            console.error('[Dashboard] Erro ao atualizar:', error);
        }
        // Chamar renderizar a tabela de torneios registrados no topo
        renderRegisteredTournamentsTable();
    }
// ===== SESSIONS (Control) =====
window.sessions = window.sessions || []; // persistido no saveCurrentUserState

function safeNumber(v, fallback = 0){
  const n = Number(v);
  return Number.isFinite(n) ? n : fallback;
}

function getAllPlayedTournamentIds(){
  // "Jogados" = tudo que tem buyin registrado
  return Object.keys(window.buyins || {}).map(k => Number(k)).filter(n => Number.isFinite(n));
}

function computeSessionSummary(ids){
  const buyins = window.buyins || {};
  const cashouts = window.cashouts || {};

  let invested = 0;
  let cash = 0;

  ids.forEach(id => {
    const b = buyins[id] || buyins[String(id)];
    const inv = safeNumber(b?.totalInvested ?? b?.baseBuyin ?? 0, 0);
    invested += inv;

    const c = cashouts[id] ?? cashouts[String(id)];
    // cashout null = pendente; undefined = n√£o existe; ambos contam como 0 no resumo
    cash += (c === null || c === undefined) ? 0 : safeNumber(c, 0);
  });

  const profit = cash - invested;
  const roi = invested > 0 ? (profit / invested) * 100 : 0;
  return { invested, cash, profit, roi };
}

function renderSessions(){
  const container = document.getElementById("historyContainer");
  if (!container) return;

  const sessions = Array.isArray(window.sessions) ? window.sessions : [];
  if (sessions.length === 0){
    container.innerHTML = `<div style="color: var(--text-secondary); font-size: 12px; text-align: center; padding: 20px">
      Nenhuma sess√£o encerrada ainda.
    </div>`;
    return;
  }

  // mais recente primeiro
  const ordered = [...sessions].sort((a,b) => new Date(b.endedAt || b.createdAt || 0) - new Date(a.endedAt || a.createdAt || 0));

  container.innerHTML = ordered.map((s, idx) => {
    const ids = Array.isArray(s.tournamentIds) ? s.tournamentIds : [];
    const sum = computeSessionSummary(ids);

    const endedLabel = s.endedAt ? new Date(s.endedAt).toLocaleString("pt-BR") : "‚Äî";
    const title = `Sess√£o #${ordered.length - idx}`;

    const rows = ids.map(id => {
    const t =  
        window.sessionsMeta?.[s.id]?.[id] ||
        ((typeof getTournamentForHistory === "function") ? getTournamentForHistory(id) : null) ||
        window.registeredMeta?.[id] ||
        { id };

      const b = window.buyins?.[id] || window.buyins?.[String(id)];
      const baseBuyin = safeNumber(t?.buyin ?? b?.baseBuyin ?? 0, 0);
      const rebuyCount = safeNumber(b?.rebuyCount ?? 0, 0);
      const totalInvested = safeNumber(b?.totalInvested ?? baseBuyin, 0);
      const c = window.cashouts?.[id] ?? window.cashouts?.[String(id)];
      const cashout = (c === null || c === undefined) ? null : safeNumber(c, 0);
      const result = (cashout === null) ? null : (cashout - totalInvested);
      const roi = (cashout === null || totalInvested <= 0) ? null : (result / totalInvested) * 100;

      const resColor = (result === null) ? "var(--text-secondary)" : (result >= 0 ? "var(--success)" : "var(--danger)");

      return `
        <tr>
          <td>${t?.name || `Torneio ${id}`}</td>
          <td>${t?.site || "-"}</td>
          <td>${t?.type || "-"}</td>
          <td style="text-align:right">${baseBuyin.toFixed(2)}</td>
          <td style="text-align:center; color: var(--secondary); font-weight:600">${rebuyCount || "-"}</td>
          <td style="text-align:right; font-weight:600">${totalInvested.toFixed(2)}</td>
          <td style="text-align:right">${cashout === null ? "Pendente" : cashout.toFixed(2)}</td>
          <td style="text-align:right; color:${resColor}; font-weight:600">${result === null ? "-" : result.toFixed(2)}</td>
          <td style="text-align:right; color:${resColor}; font-weight:600">${roi === null ? "-" : roi.toFixed(1) + "%"}</td>
        </tr>
      `;
    }).join("");

    return `
      <div class="session-card" data-session-id="${s.id}">
        <div class="session-header" onclick="toggleSessionDetails('${s.id}')">
          <div>
            <div class="session-title">${title}</div>
            <div class="session-meta">${endedLabel} ‚Ä¢ ${ids.length} torneios</div>
          </div>
          <div class="session-actions">
            <div class="session-meta" style="text-align:right">
              Inv: ${sum.invested.toFixed(2)} ‚Ä¢ Cash: ${sum.cash.toFixed(2)}<br>
              <span style="color:${sum.profit >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight:700">
                ${sum.profit.toFixed(2)} (ROI ${sum.roi.toFixed(1)}%)
              </span>
            </div>
          </div>
        </div>

        <div class="session-details">
          <table class="session-table">
            <thead>
              <tr style="color: var(--secondary); text-transform: uppercase; font-size: 10px; letter-spacing: .5px;">
                <th>Torneio</th><th>Sala</th><th>Tipo</th>
                <th style="text-align:right">Buy-in</th>
                <th style="text-align:center">Rebuy</th>
                <th style="text-align:right">Investido</th>
                <th style="text-align:right">Cashout</th>
                <th style="text-align:right">Resultado</th>
                <th style="text-align:right">ROI</th>
              </tr>
            </thead>
            <tbody>${rows || `<tr><td colspan="9" style="color:var(--text-secondary); padding:10px; text-align:center">Sem torneios.</td></tr>`}</tbody>
          </table>
        </div>
      </div>
    `;
  }).join("");
}

window.toggleSessionDetails = function(sessionId){
  const el = document.querySelector(`.session-card[data-session-id="${sessionId}"]`);
  if (el) el.classList.toggle("open");
};

async function endSession(){
  window.ensureCurrentSession?.();

  const ids = Array.isArray(window.currentSession?.tournamentIds)
    ? [...window.currentSession.tournamentIds]
    : [];

  if (ids.length === 0){
    if (typeof showNotification === "function")
      showNotification("Aviso", "Sess√£o vazia. Registre torneios antes de encerrar.", "warning");
    return;
  }

  const now = new Date().toISOString();

  const closed = {
    id: window.currentSession.id,
    startedAt: window.currentSession.startedAt,
    endedAt: now,
    tournamentIds: ids
  };

  window.sessions = Array.isArray(window.sessions) ? window.sessions : [];
  window.sessions.push(closed);

  // 1) Snapshot dos torneios dessa sess√£o (pra n√£o depender da API depois)
  window.sessionsMeta = (window.sessionsMeta && !Array.isArray(window.sessionsMeta)
   && typeof window.sessionsMeta === "object") ? window.sessionsMeta : {};

  const metaById = {};
  (closed.tournamentIds || []).forEach(id => {
    const fromHistory = (typeof getTournamentForHistory === "function") ? getTournamentForHistory(id) : null;
    const fromRegisteredMeta = window.registeredMeta?.[id];
    const fromRegisteredMap = window.registeredTournaments instanceof Map ? window.registeredTournaments.get(Number(id)) : null;

    metaById[id] = fromRegisteredMeta || fromHistory || fromRegisteredMap || { id };

  });
  window.sessionsMeta[closed.id] = metaById;
  
  // abre nova sess√£o automaticamente
  window.currentSession = {
    id: crypto?.randomUUID ? crypto.randomUUID() : `sess-${Date.now()}`,
    startedAt: now,
    tournamentIds: []
  };

  // Persistir no Supabase
  if (typeof window.saveCurrentUserState === "function"){
    await window.saveCurrentUserState({
      sessions: window.sessions,
      currentSession: window.currentSession,
      sessionsMeta: window.sessionsMeta
    });
  }

  renderSessions();
  if (typeof showNotification === "function")
    showNotification("Sess√£o encerrada", `Sess√£o salva com ${ids.length} torneios.`, "success");
}


document.getElementById("btnEndSession")?.addEventListener("click", endSession);

// Hook: sempre que Control atualizar, renderiza as sess√µes (ao inv√©s de ficar branco)
const _origUpdateControlDashboard = window.updateControlDashboard;
window.updateControlDashboard = function(){
  try { if (typeof _origUpdateControlDashboard === "function") _origUpdateControlDashboard(); } catch(e){ console.error(e); }
  try { renderSessions(); } catch(e){ console.error(e); }
};

function openCashoutModal(id) {
  const tid = Number(id);

  // 1) Tenta achar na lista atual (API)
  const tFromList =
    window.filteredTournaments?.find(x => Number(x.id) === tid) ||
    window.allTournamentsData?.find(x => Number(x.id) === tid);

  // 2) Se n√£o achou, tenta pegar do Map (stub/snapshot)
  const tFromRegistered = window.registeredTournaments instanceof Map
    ? window.registeredTournaments.get(tid)
    : null;

  const t = tFromList || tFromRegistered;
  if (!t) {
    console.warn('[Cashout] Torneio n√£o encontrado para abrir modal:', tid);
    return;
  }

  window.currentCashoutId = tid;

  document.getElementById('modalTournamentName').textContent = t.name || `Torneio ${tid}`;
  document.getElementById('modalBuyin').textContent = Number(t.buyin || 0);

  const existing = window.buyins?.[tid] || window.buyins?.[String(tid)];
  document.getElementById('rebuyCount').value = existing?.rebuyCount ?? 0;

  const c = window.cashouts?.[tid] ?? window.cashouts?.[String(tid)];
  document.getElementById('cashoutInput').value = (c ?? '');

  updateInvestedAmount();
  document.getElementById('cashoutModal').classList.add('active');
}


function updateInvestedAmount() {
    const baseBuyin = parseFloat(document.getElementById('modalBuyin').textContent.replace('$', '')) || 0;
    const rebuyCount = parseFloat(document.getElementById('rebuyCount').value) || 0;

    const totalInvested = baseBuyin * (1 + rebuyCount);

    document.getElementById('modalTotalInvested').textContent = '$' + totalInvested.toFixed(2);
    document.getElementById('modalTotalInvested').dataset.total = totalInvested;
}

function closeCashoutModal() {
    document.getElementById('cashoutModal').classList.remove('active');
    currentCashoutId = null;
}

window.saveCashout = async function() {
    if (window.currentCashoutId === null) return;
    try {
        const baseBuyin = parseFloat(document.getElementById('modalBuyin').textContent.replace('$', '')) || 0;
        const rebuyCount = parseInt(document.getElementById('rebuyCount').value) || 0;
        const cashoutValue = parseFloat(document.getElementById('cashoutInput').value) || 0;

        const totalInvested = baseBuyin * (1 + rebuyCount);

        // Salvar na estrutura
        window.buyins[window.currentCashoutId] = {
            baseBuyin: baseBuyin,
            rebuyCount: rebuyCount,
            totalInvested: totalInvested
        };

        window.cashouts[window.currentCashoutId] = cashoutValue;

        // üÜï REMOVER DO REGISTERED (torneio finalizado)
        window.registeredTournaments?.delete(Number(window.currentCashoutId));
        //delete window.registeredMeta?.[Number(window.currentCashoutId)];

            console.log(`[Cashout] ‚úÖ Torneio ${window.currentCashoutId} removido de registered`);
            
            //Atualizar o badge
            if (typeof updateRegisteredBadge === 'function') {
               updateRegisteredBadge();
            }
        

        // Salvar no Supabase
        if (window.CURRENTUSERID) {
            await storageModule.saveCashout(cashoutValue, baseBuyin, rebuyCount, totalInvested);
        }

        closeCashoutModal();
        showNotification('üí∞ Cashout Registrado', 
            `Valor $${cashoutValue} com ${rebuyCount} rebuy(s) salvo com sucesso`, 
            'success');

        renderTable();
        updateControlDashboard();
        if (typeof updateBankrollMetrics === 'function') {
            updateBankrollMetrics();
        }
        // ‚≠ê SALVAR M√âTRICAS NO SUPABASE
        if (typeof saveBankrollMetrics === 'function') {
            await saveBankrollMetrics();
        }
        // ‚úÖ Salvar estado com window.buyins e window.cashouts
        if (typeof window.saveCurrentUserState === 'function') {
            window.saveCurrentUserState({ buyins: window.buyins, cashouts: window.cashouts });
        }

    } catch (error) {
        console.error('[Storage] Erro ao salvar cashout:', error);
        alert('‚ùå Erro ao salvar cashout: ' + error.message);
    }
}


    function exportCSV() {
        const registeredTournaments = Array.from(window.registeredTournaments).values();
        if (registeredTournaments.length === 0) {
            showNotification('‚ö†Ô∏è Aviso', 'Nenhum torneio registrado para exportar', 'warning');
            return;
        }

        let csv = 'Torneio,Sala,Tipo,Buy-in,Cashout,Lucro/Preju√≠zo,ROI,Data\n';
        const today = new Date().toLocaleDateString('pt-BR');

        registeredTournaments.forEach(t => {
            const cashout = cashouts[t.id] !== undefined ? cashouts[t.id] : 'Pendente';
            let profit = '';
            let roi = '';
            if (cashout !== 'Pendente') {
                profit = (cashout - t.buyin).toFixed(2);
                roi = (profit / t.buyin * 100).toFixed(1);
            } else {
                profit = 'Pendente';
                roi = 'Pendente';
            }
            csv += `${t.name},${t.site},${t.type},${t.buyin},${cashout},${profit},${roi},${today}\n`;
        });

        const bom = '\ufeff';
        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.href = url;
        link.download = `pega-blinder-${today.replace(/\//g, '-')}.csv`;
        document.body.appendChild(link);
        link.click();
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }, 1000);

        showNotification('‚úÖ Exportado!', `Hist√≥rico exportado como CSV (${registeredTournaments.length} torneios)`, 'success');
    }

    function exportPDF() {
        const registeredTournaments = Array.from(window.registeredTournaments).values();
        if (registeredTournaments.length === 0) {
            showNotification('‚ö†Ô∏è Aviso', 'Nenhum torneio registrado para exportar', 'warning');
            return;
        }

        const totalBuyin = registeredTournaments.reduce((sum, t) => sum + t.buyin, 0);
        const totalCashout = registeredTournaments.reduce((sum, t) => sum + (cashouts[t.id] !== undefined ? cashouts[t.id] : t.buyin), 0);
        const profit = totalCashout - totalBuyin;
        const roi = totalBuyin > 0 ? (profit / totalBuyin * 100).toFixed(1) : 0;
        const today = new Date().toLocaleDateString('pt-BR');

        let html = `
            <div style="font-family: Georgia, serif; padding: 20px; color: #333;">
                <h1 style="text-align:center; color:#8b7355; margin-bottom: 10px;"> Pega Blinder Lobby</h1>
                <p style="text-align:center; color: #333; margin-bottom: 20px;"><strong>Data:</strong> ${today}</p>
                <hr style="border: none; border-top: 2px solid #8b7355; margin: 20px 0;">
                <h2 style="color: #8b7355; margin-top: 20px;">Resumo Financeiro</h2>
                <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                    <tr style="background: #f5f5f5;">
                        <td style="padding: 12px; border: 1px solid #ddd; color: #333;"><strong>Total Buy-in:</strong></td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: #333;"><strong>$${totalBuyin.toFixed(2)}</strong></td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd; color: #333;"><strong>Total Cashout:</strong></td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: #333;"><strong>$${totalCashout.toFixed(2)}</strong></td>
                    </tr>
                    <tr style="background: ${profit >= 0 ? '#d4edda' : '#f8d7da'};">
                        <td style="padding: 12px; border: 1px solid #ddd; color: #333;"><strong>Lucro/Preju√≠zo:</strong></td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: ${profit >= 0 ? '#155724' : '#721c24'}; font-weight: bold;">$${profit.toFixed(2)}</td>
                    </tr>
                    <tr style="background: ${profit >= 0 ? '#d4edda' : '#f8d7da'};">
                        <td style="padding: 12px; border: 1px solid #ddd; color: #333;"><strong>ROI:</strong></td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: ${profit >= 0 ? '#155724' : '#721c24'}; font-weight: bold;">${roi}%</td>
                    </tr>
                </table>
                <h2 style="color: #8b7355; margin-top: 30px;">Torneios Registrados</h2>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="background: #1a1813; color: #c9a961;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Torneio</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Sala</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Tipo</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">Buy-in</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">Cashout</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">Resultado</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">ROI</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${registeredTournaments.map((t, idx) => {
                            const cashout = cashouts[t.id] !== undefined ? cashouts[t.id] : '-';
                            let resultado = '-';
                            let roi_calc = '-';
                            if (cashout !== '-') {
                                resultado = (cashout - t.buyin).toFixed(2);
                                roi_calc = (resultado / t.buyin * 100).toFixed(1);
                            }
                            return `
                                <tr style="background: ${idx % 2 === 0 ? '#f9f9f9' : 'white'};">
                                    <td style="padding: 10px; border: 1px solid #ddd; color: #333;">${t.name}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; color: #333;">${t.site}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; color: #333;">${t.type}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right; color: #333;">$${t.buyin}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right; color: #333;">$${cashout}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right; color: #333;">${resultado}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right; color: #333;">${roi_calc}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <p style="text-align: center; color: #666; margin-top: 30px; font-size: 10px;">Gerado em ${new Date().toLocaleString('pt-BR')}</p>
            </div>
        `;

        const element = document.createElement('div');
        element.innerHTML = html;

        if (typeof window.html2pdf !== 'undefined' && window.html2pdf !== null) {
            const opt = {
                margin: 10,
                filename: `pega-blinder-${today.replace(/\//g, '-')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, allowTaint: true },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };

            window.html2pdf().set(opt).from(element).save()
                .then(() => {
                    showNotification('‚úÖ Exportado!', `PDF gerado (${registeredTournaments.length} torneios)`, 'success');
                })
                .catch(err => {
                    showNotification('‚ö†Ô∏è Erro no PDF', 'Tentando exportar como CSV...', 'warning');
                    setTimeout(() => exportCSV(), 500);
                });
        } else {
            showNotification('‚ö†Ô∏è Aviso', 'Biblioteca PDF n√£o carregada. Exportando como CSV...', 'warning');
            exportCSV();
        }
    }
    function getGlobalTournamentsList() {
        const buyins = window.buyins || {};
        const cashouts = window.cashouts || {};

        const ids = Object.keys(buyins)
            .map((k) => Number(k))
            .filter((n) => !Number.isNaN(n));

        return ids.map((id) => {
            // tenta pegar dados ‚Äúbonitos‚Äù (nome/site/type/date/time) se existir
            let t = null;
            if (typeof window.getTournamentForHistory === 'function') {
            try { t = window.getTournamentForHistory(id); } catch (e) { t = null; }
            }

            const buyinRow = buyins[id] || buyins[String(id)] || {};
            const baseBuyin = Number(buyinRow.baseBuyin ?? t?.buyin ?? 0);
            const totalInvested = Number(buyinRow.totalInvested ?? baseBuyin ?? 0);
            const rebuyCount = Number(buyinRow.rebuyCount ?? 0);

            const cashVal = cashouts[id] ?? cashouts[String(id)];
            const cashout = (cashVal === null || cashVal === undefined) ? null : Number(cashVal);

            return {
            id,
            name: t?.name ?? `Torneio ${id}`,
            site: t?.site ?? '-',
            type: t?.type ?? '-',
            date: t?.date ?? '',
            time: t?.time ?? '',
            baseBuyin,
            rebuyCount,
            totalInvested,
            cashout
            };
        });
    }

    function exportCSVSession() {
        const list = Array.from(window.registeredTournaments?.values?.() || []);
        if (list.length === 0) return showNotification('Aviso', 'Nenhum torneio na sess√£o para exportar.', 'warning');

        const buyins = window.buyins || {};
        const cashouts = window.cashouts || {};
        const today = new Date().toLocaleDateString('pt-BR');

        let csv = 'ID,Torneio,Sala,Tipo,Investido,Cashout,Resultado,ROI,Data\n';

        list.forEach((t) => {
            const b = buyins[t.id] || buyins[String(t.id)] || {};
            const invested = Number(b.totalInvested ?? t.buyin ?? 0);
            const cashVal = cashouts[t.id] ?? cashouts[String(t.id)];
            const cashout = (cashVal === null || cashVal === undefined) ? '' : Number(cashVal);
            const result = (cashout === '') ? '' : (Number(cashout) - invested).toFixed(2);
            const roi = (cashout === '' || invested <= 0) ? '' : (((Number(cashout) - invested) / invested) * 100).toFixed(1);

            csv += `${t.id},"${String(t.name).replaceAll('"','""')}",${t.site},${t.type},${invested.toFixed(2)},${cashout},${result},${roi},${today}\n`;
        });

        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.href = url;
        link.download = `pega-blinder-sessao-${today.replaceAll('/','-')}.csv`;
        document.body.appendChild(link);
        link.click();
        setTimeout(() => { document.body.removeChild(link); URL.revokeObjectURL(url); }, 500);
    }

    function exportPDFSession() {
        const list = Array.from(window.registeredTournaments?.values?.() || []);
        if (list.length === 0) return showNotification('Aviso', 'Nenhum torneio na sess√£o para exportar.', 'warning');

        // Reaproveita sua infra html2pdf
        const today = new Date().toLocaleDateString('pt-BR');
        const buyins = window.buyins || {};
        const cashouts = window.cashouts || {};

        const rowsHtml = list.map((t) => {
            const b = buyins[t.id] || buyins[String(t.id)] || {};
            const invested = Number(b.totalInvested ?? t.buyin ?? 0);
            const cashVal = cashouts[t.id] ?? cashouts[String(t.id)];
            const cashout = (cashVal === null || cashVal === undefined) ? null : Number(cashVal);
            const result = (cashout === null) ? null : (cashout - invested);
            const roi = (cashout === null || invested <= 0) ? null : (result / invested * 100);

            return `<tr>
            <td>${t.name}</td><td>${t.site}</td><td>${t.type}</td>
            <td style="text-align:right">${invested.toFixed(2)}</td>
            <td style="text-align:right">${cashout === null ? '-' : cashout.toFixed(2)}</td>
            <td style="text-align:right">${result === null ? '-' : result.toFixed(2)}</td>
            <td style="text-align:right">${roi === null ? '-' : roi.toFixed(1)}</td>
            </tr>`;
        }).join('');

        const html = `
            <div style="font-family: Georgia, serif; padding: 20px; color:#333">
            <h1 style="text-align:center; color:#8b7355">Pega Blinder</h1>
            <p style="text-align:center"><strong>Sess√£o</strong> - ${today}</p>
            <table style="width:100%; border-collapse:collapse; font-size:11px">
                <thead>
                <tr style="background:#1a1813; color:#c9a961">
                    <th style="padding:8px; border:1px solid #ddd; text-align:left">Torneio</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:left">Sala</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:left">Tipo</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:right">Investido</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:right">Cashout</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:right">Resultado</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:right">ROI</th>
                </tr>
                </thead>
                <tbody>${rowsHtml}</tbody>
            </table>
            </div>
        `;

        const element = document.createElement('div');
        element.innerHTML = html;

        if (!window.html2pdf) return exportCSVSession();

        window.html2pdf().set({
            margin: 10,
            filename: `pega-blinder-sessao-${today.replaceAll('/','-')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, allowTaint: true },
            jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
        }).from(element).save();
    }

    function exportCSVGlobal() {
        const list = getGlobalTournamentsList();
        if (list.length === 0) return showNotification('Aviso', 'Nenhum registro global para exportar.', 'warning');

        let csv = 'ID,Torneio,Sala,Tipo,Data,Hora,Investido,Cashout,Resultado,ROI\n';

        list
            .sort((a,b) => String(a.date||'').localeCompare(String(b.date||'')) || String(a.time||'').localeCompare(String(b.time||'')))
            .forEach((t) => {
            const invested = Number(t.totalInvested ?? 0);
            const cashout = (t.cashout === null || t.cashout === undefined) ? '' : Number(t.cashout);
            const result = (cashout === '') ? '' : (Number(cashout) - invested).toFixed(2);
            const roi = (cashout === '' || invested <= 0) ? '' : (((Number(cashout) - invested) / invested) * 100).toFixed(1);

            csv += `${t.id},"${String(t.name).replaceAll('"','""')}",${t.site},${t.type},${t.date || ''},${t.time || ''},${invested.toFixed(2)},${cashout},${result},${roi}\n`;
            });

        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.href = url;
        link.download = `pega-blinder-global-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(link);
        link.click();
        setTimeout(() => { document.body.removeChild(link); URL.revokeObjectURL(url); }, 500);
    }

    function exportPDFGlobal() {
        const list = getGlobalTournamentsList();
        if (list.length === 0) return showNotification('Aviso', 'Nenhum registro global para exportar.', 'warning');

        const sorted = list.sort((a,b) => String(a.date||'').localeCompare(String(b.date||'')) || String(a.time||'').localeCompare(String(b.time||'')));

        const totalInvested = sorted.reduce((s,t) => s + Number(t.totalInvested ?? 0), 0);
        const totalCashout = sorted.reduce((s,t) => s + Number(t.cashout ?? 0), 0);
        const profit = totalCashout - totalInvested;
        const roi = totalInvested > 0 ? (profit / totalInvested * 100) : 0;

        const rowsHtml = sorted.map((t) => {
            const invested = Number(t.totalInvested ?? 0);
            const cashout = (t.cashout === null) ? null : Number(t.cashout ?? 0);
            const result = (t.cashout === null) ? null : (cashout - invested);
            const roiLine = (t.cashout === null || invested <= 0) ? null : (result / invested * 100);

            return `<tr>
            <td>${t.date || ''} ${t.time || ''}</td>
            <td>${t.name}</td><td>${t.site}</td><td>${t.type}</td>
            <td style="text-align:right">${invested.toFixed(2)}</td>
            <td style="text-align:right">${t.cashout === null ? '-' : cashout.toFixed(2)}</td>
            <td style="text-align:right">${result === null ? '-' : result.toFixed(2)}</td>
            <td style="text-align:right">${roiLine === null ? '-' : roiLine.toFixed(1)}</td>
            </tr>`;
        }).join('');

        const html = `
            <div style="font-family: Georgia, serif; padding: 20px; color:#333">
            <h1 style="text-align:center; color:#8b7355">Pega Blinder</h1>
            <p style="text-align:center"><strong>Global</strong> - ${new Date().toLocaleString('pt-BR')}</p>

            <table style="width:100%; border-collapse:collapse; margin: 10px 0">
                <tr><td style="padding:8px; border:1px solid #ddd"><strong>Total investido</strong></td><td style="padding:8px; border:1px solid #ddd; text-align:right">${totalInvested.toFixed(2)}</td></tr>
                <tr><td style="padding:8px; border:1px solid #ddd"><strong>Total cashout</strong></td><td style="padding:8px; border:1px solid #ddd; text-align:right">${totalCashout.toFixed(2)}</td></tr>
                <tr><td style="padding:8px; border:1px solid #ddd"><strong>Lucro</strong></td><td style="padding:8px; border:1px solid #ddd; text-align:right">${profit.toFixed(2)}</td></tr>
                <tr><td style="padding:8px; border:1px solid #ddd"><strong>ROI</strong></td><td style="padding:8px; border:1px solid #ddd; text-align:right">${roi.toFixed(1)}</td></tr>
            </table>

            <table style="width:100%; border-collapse:collapse; font-size:10.5px">
                <thead>
                <tr style="background:#1a1813; color:#c9a961">
                    <th style="padding:8px; border:1px solid #ddd; text-align:left">Quando</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:left">Torneio</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:left">Sala</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:left">Tipo</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:right">Investido</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:right">Cashout</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:right">Resultado</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:right">ROI</th>
                </tr>
                </thead>
                <tbody>${rowsHtml}</tbody>
            </table>
            </div>
        `;

        const element = document.createElement('div');
        element.innerHTML = html;

        if (!window.html2pdf) return exportCSVGlobal();

        window.html2pdf().set({
            margin: 10,
            filename: `pega-blinder-global-${new Date().toISOString().slice(0,10)}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, allowTaint: true },
            jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
        }).from(element).save();
    }

    function showNotification(title, message, type = 'success') {
        const container = document.getElementById('notificationContainer');
        const toast = document.createElement('div');
        toast.className = `notification-toast ${type}`;
        toast.innerHTML = `<strong>${title}</strong><p>${message}</p>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }


    // ===== GEST√ÉO DE BANKROLL =====
    let bankrollChart = null;

    // ========== FUN√á√ÉO PRINCIPAL BANKROLL ==========
    async function updateBankrollMetrics() {
        console.log('[Bankroll] üîÑ Recalculando TODAS as m√©tricas...');
        console.log('[Bankroll] DEBUG - window.allTournamentsData existe?', !!window.allTournamentsData, window.allTournamentsData?.length);
        console.log('[Bankroll] DEBUG - window.filteredTournaments existe?', !!window.filteredTournaments, window.filteredTournaments?.length);

        // üÜï MUDAN√áA: Verificar window.buyins ao inv√©s de window.registered
        if (!window.buyins || Object.keys(window.buyins).length === 0) {
            console.log('[Bankroll] Sem dados de buyins (hist√≥rico vazio)');
            // Zerar DOM
            ['bankrollTotalTournaments', 'bankrollAvgBuyin', 'bankrollTotalProfit', 
            'bankrollROI', 'bankrollITM', 'bankrollPrizeTotal'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = id.includes('ROI') || id.includes('ITM') ? '0' : '0.00';
            });
            return;
        }

        // ‚úÖ Usar allTournamentsData (todos os torneios dispon√≠veis)
        const dataSource = window.allTournamentsData || window.filteredTournaments;
        console.log('[Bankroll] dataSource escolhido:', dataSource ? `${dataSource.length} torneios` : 'NENHUM');
        
        if (!dataSource || dataSource.length === 0) {
            console.log('[Bankroll] Sem dados de torneios da API');
            return;
        }

        // üÜï MUDAN√áA: Pegar TODOS os torneios com buyin (hist√≥rico completo)
        const allBuyinIds = Object.keys(window.buyins).map(id => parseInt(id));
        console.log('[Bankroll] üîç Total de torneios no hist√≥rico:', allBuyinIds.length);
        console.log('[Bankroll] üîç IDs:', allBuyinIds);

        const registeredTournaments = allBuyinIds
            .map(id => {
                const source = getMergedTournamentsSource();
                console.log('[Manual] carregados:', (window.manualTournaments || []).length);

                const tournament = dataSource.find(t => t.id === id);
                // ‚úÖ se n√£o achar torneio, cria um "placeholder" s√≥ para m√©tricas
                if (!tournament) {
                    const invested = Number(window.buyins?.[id]?.totalInvested || window.buyins?.[id]?.baseBuyin || 0);
                 return {
                    id,
                    name: `Torneio #${id} (hist√≥rico)`,
                    buyin: invested,
                    date: null,
                    time: null,
                    priority: 'medium',
                    _placeholder: true,
                    };
                }
                return tournament;    
            }).filter(Boolean);

        console.log('[Bankroll] Torneios v√°lidos (encontrados na API):', registeredTournaments.length);

        if (registeredTournaments.length === 0) {
            console.log('[Bankroll] ‚ö†Ô∏è Nenhum torneio encontrado na API');
            // Zerar tudo se n√£o h√° dados
            ['bankrollTotalTournaments', 'bankrollAvgBuyin', 'bankrollTotalProfit', 
            'bankrollROI', 'bankrollITM', 'bankrollPrizeTotal'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = id.includes('ROI') || id.includes('ITM') ? '0' : '0.00';
            });
            return;
        }

        // 2. C√ÅLCULOS
        let totalInvested = 0;
        let totalCashout = 0;
        
        registeredTournaments.forEach(t => {
            const buyin = window.buyins[t.id];
            const invested = parseFloat(buyin?.totalInvested || t.buyin || 0);
            
            // üÜï MUDAN√áA: Tratar cashout = null como 0 (torneios pendentes)
            const cashoutValue = window.cashouts?.[t.id];
            const cashout = (cashoutValue === null || cashoutValue === undefined) ? 0 : parseFloat(cashoutValue);
            
            console.log(`[Bankroll] üìä ID ${t.id}: invested=${invested}, cashout=${cashout}`);
            
            totalInvested += invested;
            totalCashout += cashout;
        });

        const totalProfit = totalCashout - totalInvested;
        const roi = totalInvested > 0 ? (totalProfit / totalInvested) * 100 : 0;
        const avgBuyin = totalInvested / registeredTournaments.length;
        
        // ITM: cashout > invested
        const itmCount = registeredTournaments.filter(t => {
            const invested = parseFloat(window.buyins[t.id]?.totalInvested || t.buyin || 0);
            const cashoutValue = window.cashouts?.[t.id];
            const cashout = (cashoutValue === null || cashoutValue === undefined) ? 0 : parseFloat(cashoutValue);
            return cashout > invested;
        }).length;
        const itm = (itmCount / registeredTournaments.length) * 100;

        console.log('[Bankroll] Resultado:', {
            tournaments: registeredTournaments.length,
            totalInvested: totalInvested.toFixed(2),
            totalCashout: totalCashout.toFixed(2),
            totalProfit: totalProfit.toFixed(2),
            roi: roi.toFixed(2) + '%',
            itm: itm.toFixed(1) + '%'
        });

        // 3. ATUALIZAR DOM
        document.getElementById('bankrollTotalTournaments').textContent = registeredTournaments.length;
        document.getElementById('bankrollAvgBuyin').textContent = avgBuyin.toFixed(2);
        document.getElementById('bankrollPrizeTotal').textContent = totalCashout.toFixed(2);
        
        const profitEl = document.getElementById('bankrollTotalProfit');
        profitEl.textContent = totalProfit.toFixed(2);
        profitEl.style.color = totalProfit >= 0 ? 'var(--success)' : 'var(--danger)';
        
        document.getElementById('bankrollROI').textContent = roi.toFixed(2);
        document.getElementById('bankrollITM').textContent = itm.toFixed(1);

        // 4. Banca Atual
        const initialBank = parseFloat(document.getElementById('bankrollInitialBank')?.value || 1000);
        const currentBank = initialBank + totalProfit;
        document.getElementById('bankrollCurrentBank').textContent = currentBank.toFixed(2);

        console.log('[Bankroll] ‚úÖ DOM atualizada!');
    }

    // ========== ATIVAR ABA BANKROLL ==========
    document.querySelectorAll('.view-btn[data-view="bankroll"]').forEach(btn => {
        btn.addEventListener('click', async () => {
            console.log('[Bankroll] Aba ativada - recalculando...');
            await updateBankrollMetrics();
        });
    });
    


// ========== GR√ÅFICO DE LUCRO ACUMULADO (por quantidade de torneios) ==========
function updateBankrollChart(tournaments) {
  const canvas = document.getElementById('bankrollChart');
  if (!canvas) {
    console.warn('[Chart] Canvas n√£o encontrado!');
    return;
  }

  if (typeof Chart === 'undefined') {
    console.warn('[Chart] Chart.js n√£o carregado, pulando gr√°fico');
    return;
  }

  try {
    const ctx = canvas.getContext('2d');
    
    
    // Ordenar por data mais antigo primeiro (seguro com date null/undefined)
    const sortedTournaments = [...(tournaments || [])].sort((a, b) => {
        const da = String(a?.date ?? '');
        const db = String(b?.date ?? '');
        return da.localeCompare(db);
    });

    
    // Calcular lucro acumulado por N√öMERO DE TORNEIOS (n√£o por data)
    const labels = [];
    const data = [];
    let cumulativeProfit = 0;
    
    sortedTournaments.forEach((t, index) => {
      const invested = parseFloat(window.buyins[t.id]?.totalInvested || t.buyin || 0);
      
      // üÜï MUDAN√áA: Tratar cashout = null como 0 (torneios pendentes)
      const cashoutValue = window.cashouts?.[t.id];
      const cashout = (cashoutValue === null || cashoutValue === undefined) ? 0 : parseFloat(cashoutValue);
      
      const profit = cashout - invested;
      cumulativeProfit += profit;
      
      // Label: n√∫mero do torneio (1¬∫, 2¬∫, 3¬∫, etc)
      labels.push(`${index + 1}`);
      data.push(cumulativeProfit);
    });

    // Destruir gr√°fico anterior COM SEGURAN√áA
    if (window.bankrollChart && typeof window.bankrollChart.destroy === 'function') {
      window.bankrollChart.destroy();
    }

    // Criar novo gr√°fico
    window.bankrollChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Lucro Acumulado ($)',
          data: data,
          borderColor: data[data.length-1] >= 0 ? '#10b981' : '#ef4444',
          backgroundColor: data[data.length-1] >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
          tension: 0.3,
          fill: true,
          borderWidth: 2,
          pointRadius: 4,
          pointBackgroundColor: data[data.length-1] >= 0 ? '#10b981' : '#ef4444'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { 
              callback: v => '$' + v.toFixed(0)
            }
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: ctx => `Lucro: $${ctx.parsed.y.toFixed(2)}`
            }
          }
        }
      }
    });
    
    console.log('[Chart] ‚úÖ Gr√°fico atualizado:', data.length, 'pontos (por qtdade de torneios)');
  } catch (error) {
    console.error('[Chart] Erro ao desenhar gr√°fico:', error);
  }
}

// Helper: resolve torneio do hist√≥rico SEM depender da API atual (50 itens)
// - tenta achar no allTournamentsData/filteredTournaments
// - se n√£o achar, cria um placeholder usando buyins + (se existir) registeredMeta
function getTournamentForHistory(id) {
  const tid = Number(id);

  const live =
    (window.allTournamentsData || []).find(t => Number(t.id) === tid) ||
    (window.filteredTournaments || []).find(t => Number(t.id) === tid) ||
    null;

  if (live) return live;

  const meta = window.registeredMeta?.[tid] || window.POKER?.registeredMeta?.[tid] || null;
  const b = window.buyins?.[tid] || window.buyins?.[String(tid)] || null;

  return {
    id: tid,
    name: meta?.name || `Torneio ${tid} (hist√≥rico)`,
    site: meta?.site || '-',
    type: meta?.type || '-',
    // buyin aqui √© s√≥ fallback, o c√°lculo usa buyins[tid].totalInvested quando tiver
    buyin: Number(meta?.buyin ?? b?.baseBuyin ?? b?.totalInvested ?? 0),
    // se voc√™ tiver snapshot com date/time, isso permite m√™s-a-m√™s completo
    date: meta?.date ?? null,
    time: meta?.time ?? null,
    placeholder: true
  };
}


// ========== TABELA M√äS A M√äS (corrigida) ==========
function updateMonthlyStats(tournamentsInput) {
  const tbody = document.getElementById('bankrollMonthlyBody');
  if (!tbody) {
    console.warn('[Monthly] tbody n√£o encontrado!');
    return;
  }

  const allBuyinIds = Object.keys(window.buyins || {}).map(id => Number(id));
  const tournaments = Array.isArray(tournamentsInput)
    ? tournamentsInput
    : allBuyinIds.map(getTournamentForHistory);

  // Para m√™s-a-m√™s, precisamos de data. Se n√£o tiver, pula (ou voc√™ pode agrupar em "Sem data").
  const tournamentsWithDate = tournaments.filter(t => t && t.date);

  console.log('[Monthly] üîç Torneios para tabela mensal (com data):', tournamentsWithDate.length);

  if (tournamentsWithDate.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary)">Sem dados</td></tr>';
    return;
  }

  const monthly = {};

  tournamentsWithDate.forEach(t => {
    const d = new Date(t.date);
    if (Number.isNaN(d.getTime())) return;

    const monthKey = d.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });

    if (!monthly[monthKey]) {
      monthly[monthKey] = { tournaments: 0, invested: 0, cashout: 0 };
    }

    const buyinRec = window.buyins?.[t.id] || window.buyins?.[String(t.id)];
    const invested = Number(buyinRec?.totalInvested ?? buyinRec?.baseBuyin ?? t.buyin ?? 0);

    // pendente = null (mas para m√©trica, null/undefined vira 0)
    const cashVal = window.cashouts?.[t.id] ?? window.cashouts?.[String(t.id)];
    const cashout = (cashVal === null || cashVal === undefined) ? 0 : Number(cashVal);

    monthly[monthKey].tournaments++;
    monthly[monthKey].invested += invested;
    monthly[monthKey].cashout += cashout;
  });

  tbody.innerHTML = '';

  Object.entries(monthly).forEach(([month, stats]) => {
    const profit = stats.cashout - stats.invested;
    const roi = stats.invested > 0 ? (profit / stats.invested) * 100 : 0;

    const row = `
      <tr>
        <td style="padding: 8px 0; color: var(--text-primary); font-weight: 500">${month}</td>
        <td style="padding: 8px 0; text-align: right">${stats.tournaments}</td>
        <td style="padding: 8px 0; text-align: right">$${stats.invested.toFixed(2)}</td>
        <td style="padding: 8px 0; text-align: right">$${stats.cashout.toFixed(2)}</td>
        <td style="padding: 8px 0; text-align: right; color: ${profit >= 0 ? 'var(--success)' : 'var(--danger)'}">
          $${profit.toFixed(2)}
        </td>
        <td style="padding: 8px 0; text-align: right; font-weight: 600">
          ${roi.toFixed(1)}%
        </td>
      </tr>
    `;
    tbody.innerHTML += row;
  });

  console.log('[Monthly] ‚úÖ Tabela m√™s a m√™s atualizada:', Object.keys(monthly).length, 'meses');
}


// ========== REFRESH COMPLETO (corrigido) ==========
async function refreshAllBankrollMetrics() {
  console.log('[Bankroll] üîÑ Refresh completo iniciado...');
  await updateBankrollMetrics();

  const allBuyinIds = Object.keys(window.buyins || {}).map(id => Number(id));
  const tournaments = allBuyinIds.map(getTournamentForHistory); // ‚úÖ sem depender da API, sem filter(Boolean)

  console.log('[Bankroll] üîç Torneios para gr√°fico e tabela:', tournaments.length);

  if (tournaments.length > 0) {
    updateBankrollChart(tournaments);
    updateMonthlyStats(tournaments); // ‚úÖ passa a lista pronta
  } else {
    console.warn('[Bankroll] ‚ö†Ô∏è Nenhum torneio encontrado para gr√°fico/tabela');
    updateBankrollChart([]);
    updateMonthlyStats([]);
  }

  console.log('[Bankroll] ‚úÖ Refresh completo finalizado!');
}



// ========== HOOK AUTOM√ÅTICO ==========
document.querySelectorAll('.view-btn[data-view="bankroll"]').forEach(btn => {
  btn.addEventListener('click', refreshAllBankrollMetrics);
});

// Chamar na inicializa√ß√£o
if (document.querySelector('.view-btn[data-view="bankroll"].active')) {
  setTimeout(refreshAllBankrollMetrics, 500);
}
 
    const origSaveCashout = saveCashout;
    function waitForUserId(callback, maxRetries = 10) {
    let attempts = 0;
    
    const checkUserId = setInterval(() => {
        attempts++;
        
        if (window.CURRENTUSERID) {
        console.log('[Storage] User ID encontrado:', window.CURRENTUSERID);
        clearInterval(checkUserId);
        callback();
        } else if (attempts >= maxRetries) {
        console.error('[Storage] User ID n√£o encontrado ap√≥s', maxRetries, 'tentativas');
        clearInterval(checkUserId);
        }
    }, 100);
}


</script>
<script> // BLOCO 4Ô∏è‚É£: INICIALIZA√á√ÉO CONSOLIDADA

    // ============================================
    // 1. AGUARDAR USER ID DISPON√çVEL
    // ============================================
    let attempts = 0;
    const waitForUserIdPromise = new Promise((resolve) => {
        const checkUserId = setInterval(() => {
            if (window.CURRENTUSERID) {
                clearInterval(checkUserId);
                console.log('[Init] ‚úÖ User ID dispon√≠vel:', window.CURRENTUSERID);
                resolve();
            }
            attempts++;
            if (attempts >= 50) {
                clearInterval(checkUserId);
                console.warn('[Init] ‚ö†Ô∏è  User ID n√£o encontrado ap√≥s 50 tentativas');
                resolve();
            }
        }, 100);
    });

    // ============================================
    // 2. INICIALIZA√á√ÉO NA DOMContentLoaded
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('[Init] üöÄ DOMContentLoaded disparado');
        
        // Aguardar User ID estar dispon√≠vel
        await waitForUserIdPromise;
        
        // Pequeno delay para garantir que tudo est√° pronto
        await new Promise(r => setTimeout(r, 300));

        // ============================================
        // 3. REGISTRAR FUN√á√ïES GLOBAIS
        // ============================================
        window.saveCurrentUserState = async (data = {}) => {
            if (typeof window.storageModule === 'undefined' || typeof window.storageModule.saveUserState !== 'function') {
                console.warn('[Init] storageModule.saveUserState n√£o dispon√≠vel');
                return null;
            }

              // garante estruturas
            window.registeredMeta = window.registeredMeta || {};
            window.buyins = window.buyins || {};
            window.cashouts = window.cashouts || {};
            // sempre manda o "core" + overrides
            const payload = {
                buyins: window.buyins || {},
                cashouts: window.cashouts || {},
                currentCashoutId: window.currentCashoutId ?? null,
                selectedGames: Array.from(window.selectedGames || ['ALL']),
                selectedVenues: Array.from(window.selectedVenues || ['ALL']),
                filteredTournaments: window.filteredTournaments || [],
                registeredMeta: window.registeredMeta,
                ...data,
            };

            return await window.storageModule.saveUserState(payload);
        };

        
        window.updateBankroll = async (amount) => {
            if (typeof window.storageModule !== 'undefined' && typeof window.storageModule.updateBankroll === 'function') {
                return await window.storageModule.updateBankroll(amount);
            } else {
                console.warn('[Init] storageModule.updateBankroll n√£o dispon√≠vel');
            }
        };
        
        window.saveCashoutToSupabase = async (cashoutValue, baseBuyin, rebuyCount, totalInvested) => {
            if (typeof window.storageModule !== 'undefined' && typeof window.storageModule.saveCashout === 'function') {
                return await window.storageModule.saveCashout(cashoutValue, baseBuyin, rebuyCount, totalInvested);
            } else {
                console.warn('[Init] storageModule.saveCashout n√£o dispon√≠vel');
            }
        };
        
        window.saveUsersToStorage = async (users) => {
            if (typeof window.storageModule !== 'undefined' && typeof window.storageModule.saveUsersToStorage === 'function') {
                return await window.storageModule.saveUsersToStorage(users);
            } else {
                console.warn('[Init] storageModule.saveUsersToStorage n√£o dispon√≠vel');
            }
        };

        console.log('[Init] ‚úÖ Fun√ß√µes globais registradas');

        // ============================================
        // 4. CARREGAR DADOS SALVOS DO USU√ÅRIO
        // ============================================
        if (typeof window.loadUserData === 'function') {
            try {
                console.log('[Init] Carregando dados do usu√°rio...');
                await window.loadUserData();
                // garante array mesmo se falhar
                window.manualTournaments = [];

                // carrega manuais do Supabase
                if (typeof loadManualTournamentsFromSupabase === 'function') {
                window.manualTournaments = await loadManualTournamentsFromSupabasePublic();
                console.log('[Init] Manual tournaments:', window.manualTournaments.length);
                } else {
                console.warn('[Init] loadManualTournamentsFromSupabase n√£o existe');
                }

                // IMPORTANTE: aqui voc√™ ainda n√£o tem certeza que a API j√° carregou.
                // Ent√£o ou voc√™ chama loadTournamentsFromAPI agora, ou deixa ela rodar e aplicar filtros depois.
                if (typeof window.resetTournamentsPagination === 'function') {
                await window.resetTournamentsPagination(); // isso chama loadTournamentsFromAPI(reset=true) no seu c√≥digo
                }

                // agora sim: filtros enxergam API + manuais (desde que applyFilters use a fonte mesclada)
                if (typeof applyFilters === 'function') applyFilters();

                console.log('[Init] ‚úÖ Dados do usu√°rio + manuais + API carregados');
            } catch (error) {
                console.error('[Init] ‚ùå Erro ao carregar dados:', error);
            }
            } else {
            console.warn('[Init] ‚ö†Ô∏è loadUserData n√£o √© fun√ß√£o');
        }

        // ============================================
        // 5. CRIAR ALIASES (window.buyins, window.cashouts, etc)
        // ============================================
        if (typeof window.updateAliases === 'function') {
            try {
                window.updateAliases();
                console.log('[Init] ‚úÖ Aliases atualizados');
            } catch (error) {
                console.warn('[Init] ‚ö†Ô∏è  Erro ao atualizar aliases:', error);
            }
        }

        // ============================================
        // 6. CARREGAR TORNEIOS DA API
        // ============================================
        if (typeof window.loadTournamentsFromAPI === 'function') {
            try {
                console.log('[Init] Carregando torneios da API...');

                const apiTournaments = await window.loadTournamentsFromAPI();

                if (!Array.isArray(apiTournaments)) {
                console.warn('[Init] ‚ö†Ô∏è API retornou dados inv√°lidos');
                return;
                }

                // Base (n√£o filtrada)
                window.allTournamentsData = apiTournaments;

                // Aplica filtros para gerar window.filteredTournaments corretamente
                if (typeof window.applyFilters === 'function') {
                window.applyFilters();
                } else {
                // fallback: sem applyFilters, pelo menos espelha
                window.filteredTournaments = [...apiTournaments];
                }

                // Mesclar status de registered APENAS para render/UI (sem destruir a base)
                const registeredSet = window.registered instanceof Set ? window.registered : new Set();
                window.filteredTournaments = window.filteredTournaments.map(t => ({
                    ...t,
                    registered: window.registeredTournaments?.has(Number(t.id)) || false,
                }));

                console.log('[Init] ‚úÖ Torneios carregados:', window.allTournamentsData.length,
                            '| Filtrados:', window.filteredTournaments.length);

                // Atualizar bankroll depois que buyins/cashouts tamb√©m existirem
                if (typeof window.refreshAllBankrollMetrics === 'function') {
                window.refreshAllBankrollMetrics();
                } else if (typeof updateBankrollMetrics === 'function') {
                updateBankrollMetrics();
                }
            } catch (error) {
                console.error('[Init] ‚ùå Erro ao carregar torneios:', error);
            }
            } else {
            console.warn('[Init] ‚ö†Ô∏è loadTournamentsFromAPI n√£o √© fun√ß√£o');
        }

    
        // ============================================
        // 7. INICIALIZAR APP
        // ============================================
        if (typeof window.initializeApp === 'function') {
            try {
                console.log('[Init] Inicializando aplica√ß√£o...');
                await window.initializeApp();
                console.log('[Init] ‚úÖ Aplica√ß√£o inicializada com sucesso');
            } catch (error) {
                console.error('[Init] ‚ùå Erro em initializeApp:', error);
            }
        } else {
            console.warn('[Init] ‚ö†Ô∏è  initializeApp n√£o √© fun√ß√£o');
        }

        // ============================================
        // 8. RENDERIZAR TABELA
        // ============================================
        if (typeof window.renderTable === 'function') {
            try {
                console.log('[Init] Renderizando tabela...');
                window.renderTable();
                console.log('[Init] ‚úÖ Tabela renderizada');
            } catch (error) {
                console.error('[Init] ‚ùå Erro ao renderizar tabela:', error);
            }
        } else {
            console.warn('[Init] ‚ö†Ô∏è  renderTable n√£o √© fun√ß√£o');
        }


        // ============================================
        // ‚úÖ FINALIZA√á√ÉO
        // ============================================
        console.log('[Init] üéâ APLICA√á√ÉO TOTALMENTE INICIALIZADA!');
        console.log('[Init] Status Final:', {
            userIdPresent: !!window.CURRENTUSERID,
            pokerExists: typeof window.POKER === 'object',
            tournamentsLoaded: Array.isArray(window.filteredTournaments),
            tournamentsCount: window.filteredTournaments?.length || 0,
            registeredCount: window.registeredTournaments?.size || 0
        });
    });

</script>


</body>

</html>
